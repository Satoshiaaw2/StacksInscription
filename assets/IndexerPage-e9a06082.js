import{_ as z,z as X,i as T,U as y,A as q,G as V,H as F,D as A,u as P,a as D,o as d,c as h,e as o,w as a,m as l,t as c,s as I,f as v,x as L,b as u,v as O,I as N,p as G,g as H}from"./index-e82bf540.js";import{d as M,c as j,C as J,e as K,m as W}from"./ContractHelper-4d038210.js";import{C as Y}from"./ChainHelper-551bbcda.js";import{s as Z}from"./supabase-b08699b0.js";const w=O(),_=L(),$={name:"ToolsPage",components:{},data(){return{bSignedIn:X.isUserSignedIn(),netType:T(),summary:{latestInscription:" ",driveToInscription:" ",balance:" "},queryData:{queryState:0,content:"",latestInscription:0,driveToInscription:0,loadDedicatedServerState:0},foundTableData:[],notFoundTableData:[],driveDialogData:{kRewardUnit:1e3,bVisible:!1,extraTitle:"",maxDriveCount:0,driveCount:0,rewardValue:0,rewardExtraTip:""}}},computed:{},async mounted(){this.loadSummary();let i=this;setInterval(()=>{i.loadSummary()},15e3)},methods:{async loadSummary(){const i={contractAddress:_.indexerContract.address,contractName:_.indexerContract.name,functionName:"get_summary",functionArgs:[],network:w,senderAddress:_.indexerContract.address},t=await M(i),n=j(t);this.summary.latestInscription=parseInt(n.latest_token_id.value),this.summary.driveToInscription=parseInt(n.last_synced_token_id.value),this.summary.balance=parseInt(n.balance.value),this.driveDialogData.bVisible&&this.updateDriveDialogContent(!0)},async onClickQuery(){this.foundTableData.splice(0,this.foundTableData.length),this.notFoundTableData.splice(0,this.notFoundTableData.length);let i={},t=[];const n=new TextEncoder,r=this.queryData.content.split(`
`);for(const s of r){const m=s.trim();if(n.encode(m).length>128){y.alert(`"${m}" exceeds max length 128!`);return}m.length>0&&!(m in i)&&(i[m]=!0,t.push(m))}if(t.length>25){y.alert(`Max 25 items, currently ${t.length}`);return}this.queryData.queryState=1,this.queryData.loadDedicatedServerState=0,this.queryData.latestInscription=this.summary.latestInscription,this.queryData.driveToInscription=this.summary.driveToInscription;const e=await J.queryIndexer(t);if(this.queryData.queryState=2,!!e)for(const s of e)if(s.tokenId>0){const m=this.$router.resolve({path:`/inscription/${s.tokenId}`});this.foundTableData.push({content:s.content,tokenId:s.tokenId,tokenUrl:m.href})}else this.notFoundTableData.push(s.content)},async onClickQueryDedicateServer(){if(this.notFoundTableData.length<=0)return;let i=[];for(const t of this.notFoundTableData)i.push(t);try{this.queryData.loadDedicatedServerState=1;const{data:t,error:n,status:r}=await Z.from("inscriptions").select("id, payload").gt("id",this.queryData.driveToInscription).order("id",{ascending:!0}).eq("type","text").in("payload",i).limit(1e3);if(r==200&&!n)this.showDedicatesServerData(t);else{console.log("onClickQueryDedicateServer error",r,n),y.alert(`Query server fail, status=${r}`);return}}catch(t){y.alert("Query server fail"),console.log("onClickQueryDedicateServer err",t);return}finally{this.queryData.loadDedicatedServerState=2}},async showDedicatesServerData(i){let t={};for(const n of i)if(!t[n.payload]){t[n.payload]=!0;const r=this.$router.resolve({path:`/inscription/${n.id}`});this.foundTableData.push({content:n.payload,tokenId:n.id,tokenUrl:r.href});const e=this.notFoundTableData.indexOf(n.payload);e!=-1&&this.notFoundTableData.splice(e,1)}},onClickDrive(){if(!this.bSignedIn){q();return}if(this.summary.latestInscription==" ")return;if(this.summary.latestInscription-this.summary.driveToInscription<=0){y.alert("Not need drive");return}this.updateDriveDialogContent(),this.driveDialogData.bVisible=!0},updateDriveDialogContent(i){const t=this.summary.latestInscription-this.summary.driveToInscription;if(this.driveDialogData.extraTitle=`(behind ${t} inscriptions)`,this.driveDialogData.maxDriveCount=t,!i){let n=[1,50,100,200,400],r=0;for(const e of n)if(t<=e){r=e;break}r||(r=n[n.length-1]),this.driveDialogData.driveCount=r}this.updateDriveDialogReward()},updateDriveDialogReward(){const i=Math.min(this.driveDialogData.driveCount,this.driveDialogData.maxDriveCount),t=this.driveDialogData.kRewardUnit*i;this.summary.balance==0?(this.driveDialogData.rewardValue=0,this.driveDialogData.rewardExtraTip="Reward pool is empty"):this.summary.balance<t?(this.driveDialogData.rewardValue=this.summary.balance,this.driveDialogData.rewardExtraTip="All of reward pool"):(this.driveDialogData.rewardValue=t,this.driveDialogData.rewardExtraTip="")},onClickSureDrive(){const i=this.driveDialogData.driveCount;let t=null;i==1?t="drive":t=`drive_${i}`;let n=[];n.push(K(_.indexerContract.address,_.indexerContract.name,V.GreaterEqual,0n));let r=[];const e={contractAddress:_.indexerContract.address,contractName:_.indexerContract.name,functionName:t,functionArgs:r,network:w,appDetails:N(),postConditions:n,onFinish:s=>{y.alert(`Drive transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${s.txId}?chain=${T()}" target="_blank">Visit transaction.</a>`)}};F(e)},onClickDonate(){if(!this.bSignedIn){q();return}let i=this;this.$prompt("Input the amount(STX) you'd like to donate:","Donate",{confirmButtonText:"Ok",cancelButtonText:"Cancel",inputPattern:/^[0-9|\.]{1,}$/,inputErrorMessage:"Invalid amount",autofocus:!0}).then(({value:t})=>{i.sureDonate(t)})},async sureDonate(i){const t=parseInt(i);if(t<=0||t>1e3){y.alert("Invalid amount, should between 1 to 1000");return}const n=t*1e6,r=await Y.getAccountBalance(A());if(r<=n){y.alert("Balance unenough");return}if(r<=n+1e6){let e=this;this.$confirm(`Balance: ${r/1e6} STX, donate: ${n/1e6} STX, make sure fee less than ${(r-n)/1e6} STX!`,"Attention",{confirmButtonText:"Got it",cancelButtonText:"Cancel",type:"warning"}).then(()=>{e.popupDonate(n)})}else this.popupDonate(n)},popupDonate(i){let t=[];t.push(W(A(),V.Equal,i));const n=[P(i)],r={contractAddress:_.indexerContract.address,contractName:_.indexerContract.name,functionName:"donate",functionArgs:n,network:w,appDetails:N(),postConditions:t,onFinish:e=>{y.alert(`Donate transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${e.txId}?chain=${T()}" target="_blank">Visit transaction.</a>`)}};F(r)}}},f=i=>(G("data-v-07c703e9"),i=i(),H(),i),ee={id:"main"},te=f(()=>u("div",{id:"title"},"On-chain first-is-first text indexer",-1)),ae=f(()=>u("div",{class:"ins1"}," Latest inscription ",-1)),ne={class:"svalue"},ie=f(()=>u("div",{class:"ins2"}," Index-to inscription ",-1)),oe={class:"svalue"},re=f(()=>u("div",{class:"ins3"}," Reward pool ",-1)),se={class:"svalue"},le={key:0},de={key:1},ce=f(()=>u("div",{id:"tip"},"Input query items(max 25 items, max 128 characters per item):",-1)),ue={key:0,id:"attention"},pe={key:0},me={key:0},De={key:1},he={key:1},ye=f(()=>u("div",{style:{color:"#0c0"}},"Found:",-1)),_e={class:"contentCol"},ve=["href"],fe=f(()=>u("div",{style:{color:"#cc0"}},"Not found:",-1)),ge={class:"contentCol"},be={key:1},Ce={key:0};function xe(i,t,n,r,e,s){const m=D("el-descriptions-item"),g=D("el-button"),E=D("el-descriptions"),b=D("el-space"),B=D("el-input"),C=D("el-table-column"),S=D("el-table"),x=D("el-radio"),R=D("el-radio-group"),k=D("el-form-item"),U=D("el-form"),Q=D("el-dialog");return d(),h("div",ee,[o(b,{fill:"",direction:"vertical"},{default:a(()=>[te,o(E,{column:3,size:"default",direction:"vertical",border:""},{default:a(()=>[o(m,null,{label:a(()=>[ae]),default:a(()=>[u("div",ne,c(e.summary.latestInscription),1)]),_:1}),o(m,null,{label:a(()=>[ie]),default:a(()=>[u("div",oe,[l(c(e.summary.driveToInscription)+" ",1),e.summary.driveToInscription!=" "&&e.summary.driveToInscription<e.summary.latestInscription?(d(),I(g,{key:0,type:"primary",size:"small",style:{"margin-left":"8px"},onClick:s.onClickDrive,plain:""},{default:a(()=>[l("Drive")]),_:1},8,["onClick"])):v("",!0)])]),_:1}),o(m,null,{label:a(()=>[re]),default:a(()=>[u("div",se,[e.summary.balance!=" "?(d(),h("span",le,c(e.summary.balance/1e6)+" STX",1)):(d(),h("span",de,"Â ")),e.summary.balance!=" "?(d(),I(g,{key:2,type:"primary",size:"small",style:{"margin-left":"8px"},plain:"",onClick:s.onClickDonate},{default:a(()=>[l("Donate")]),_:1},8,["onClick"])):v("",!0)])]),_:1})]),_:1})]),_:1}),o(b,{direction:"vertical",alignment:"start",style:{margin:"60px auto",width:"900px"}},{default:a(()=>[ce,o(B,{modelValue:e.queryData.content,"onUpdate:modelValue":t[0]||(t[0]=p=>e.queryData.content=p),style:{width:"900px"},autosize:{minRows:5,maxRows:25},placeholder:`bitcoin
Bitcoin
Punk5558 was here`,type:"textarea"},null,8,["modelValue"]),o(g,{type:"primary",size:"large",onClick:s.onClickQuery,disabled:e.queryData.content.trim().length==0,loading:e.queryData.queryState==1},{default:a(()=>[l("Query many")]),_:1},8,["onClick","disabled","loading"])]),_:1}),e.queryData.queryState==2&&e.notFoundTableData.length>0&&e.queryData.driveToInscription<e.queryData.latestInscription?(d(),h("div",ue,[l(" Attention: Index to #"+c(e.queryData.driveToInscription)+" currently, ",1),e.queryData.loadDedicatedServerState!=2?(d(),h("span",pe,[l(' "Not found" items may occur '),e.queryData.driveToInscription+1<e.queryData.latestInscription?(d(),h("span",me," between #"+c(e.queryData.driveToInscription+1)+" to #"+c(e.queryData.latestInscription)+". ",1)):(d(),h("span",De," in #"+c(e.queryData.latestInscription)+". ",1))])):(d(),h("span",he," results between #"+c(e.queryData.driveToInscription+1)+" and #"+c(e.queryData.latestInscription)+" are calculated by dedicated server. ",1)),e.notFoundTableData.length>0&&e.queryData.loadDedicatedServerState!=2?(d(),I(g,{key:2,size:"small",type:"primary",plain:"",onClick:s.onClickQueryDedicateServer,loading:e.queryData.loadDedicatedServerState==1},{default:a(()=>[l("Query dedicated server")]),_:1},8,["onClick","loading"])):v("",!0)])):v("",!0),e.queryData.queryState==2?(d(),I(b,{key:1,alignment:"start",style:{width:"900px"}},{default:a(()=>[o(b,{direction:"vertical",alignment:"start"},{default:a(()=>[ye,o(S,{stripe:"",border:"",style:{width:"500px"},size:"default",data:e.foundTableData,"empty-text":"Empty"},{default:a(()=>[o(C,{type:"index",width:"50"}),o(C,{label:"Content",width:"300"},{default:a(p=>[u("div",_e,c(p.row.content),1)]),_:1}),o(C,{label:"Inscription #"},{default:a(p=>[u("a",{class:"tokenUrlA",href:p.row.tokenUrl,target:"_blank"},c(p.row.tokenId),9,ve)]),_:1})]),_:1},8,["data"])]),_:1}),o(b,{direction:"vertical",alignment:"start",style:{"margin-left":"50px"}},{default:a(()=>[fe,o(S,{size:"default",stripe:"",border:"",data:e.notFoundTableData,"empty-text":"Empty"},{default:a(()=>[l(" empty-text='Empty'> "),o(C,{type:"index",width:"50"}),o(C,{label:"Content",width:"300"},{default:a(p=>[u("div",ge,c(p.row),1)]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})):v("",!0),o(Q,{center:!0,title:"Drive "+e.driveDialogData.extraTitle,modelValue:e.driveDialogData.bVisible,"onUpdate:modelValue":t[3]||(t[3]=p=>e.driveDialogData.bVisible=p),width:"600px"},{default:a(()=>[o(U,{class:"fcenter",ref:"form",model:e.driveDialogData,"label-width":"100"},{default:a(()=>[o(k,{label:"Drive times:"},{default:a(()=>[e.driveDialogData.maxDriveCount>=1?(d(),I(R,{key:0,modelValue:e.driveDialogData.driveCount,"onUpdate:modelValue":t[1]||(t[1]=p=>e.driveDialogData.driveCount=p),onChange:s.updateDriveDialogReward},{default:a(()=>[o(x,{label:1},{default:a(()=>[l("1")]),_:1}),o(x,{label:50},{default:a(()=>[l("50")]),_:1}),o(x,{label:100},{default:a(()=>[l("100")]),_:1}),o(x,{label:200},{default:a(()=>[l("200")]),_:1}),o(x,{label:400},{default:a(()=>[l("400")]),_:1})]),_:1},8,["modelValue","onChange"])):v("",!0),e.driveDialogData.maxDriveCount==0?(d(),h("span",be,"Not need drive")):v("",!0)]),_:1}),o(k,{label:"Reward:"},{default:a(()=>[u("span",null,[l(c(e.driveDialogData.rewardValue/1e6)+" STX ",1),e.driveDialogData.rewardExtraTip.length>0?(d(),h("span",Ce,"("+c(e.driveDialogData.rewardExtraTip)+")",1)):v("",!0)])]),_:1}),o(k,null,{default:a(()=>[o(g,{type:"primary",onClick:s.onClickSureDrive},{default:a(()=>[l("Drive")]),_:1},8,["onClick"]),o(g,{onClick:t[2]||(t[2]=p=>e.driveDialogData.bVisible=!1)},{default:a(()=>[l("Cancel")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])}const Se=z($,[["render",xe],["__scopeId","data-v-07c703e9"]]);export{Se as default};
