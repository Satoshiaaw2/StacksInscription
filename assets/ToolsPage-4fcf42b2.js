import{a as U,U as d,A as P,G as w,j as B,u as A,k as z,E,i as L,L as W,K as M,N as j,I as O,b as g,o as y,c as D,f as a,w as o,q as T,g as I,s as Q,v as J,m as q,d as b,t as N,p as G,h as K,J as X}from"./index-492f4f73.js";import{c as R,C as Y,d as Z}from"./ContractHelper-fb9fbece.js";import{C as V}from"./ChainHelper-628b4753.js";const S=Q(),h=J(),$={name:"ToolsPage",components:{},data(){return{u:d,bSignedIn:P.isUserSignedIn(),kFixImageHeight:128,defaultReadonlyAddress:h.defaultContractAddress,activeTabName:"query-holdings",queryHoldingData:{address:"",resolvedAddress:"",nftName:"inscription",state:0,pageLimit:25,total:0,curPage:1,resultCache:{},tableData:[],bInRequestEncounterFail:!1,startLoadAllFlag:0,curInRequestCount:0,kMaxInRequestCount:10},tranInsData:{tokenId:"",address:""}}},computed:{queryHoldingsBtnValid(){return this.queryHoldingData.address.trim().length>0},transferInsBtnValid(){return this.bSignedIn&&/^[0-9]{1,16}$/.test(this.tranInsData.tokenId.trim())&&this.tranInsData.address.trim().length>0}},async mounted(){},methods:{onClickFillAddress(){this.queryHoldingData.address=w()},async onClickQueryHoldings(){this.queryHoldingData.state=1;const t=await V.resolveAddress(this.queryHoldingData.address.trim());if(t.ret!=0){this.queryHoldingData.state=0,d.alert(t.errMsg);return}if(!d.parseAddress(t.value)){this.queryHoldingData.state=0,d.alertInvalidAddress();return}this.queryHoldingData.resolvedAddress=t.value,this.queryHoldingPage(1,!0)},async queryHoldingPage(t,s){this.queryHoldingData.state=1;const i=(t-1)*this.queryHoldingData.pageLimit,m=await V.getNFTHoldings(h.defaultContractAddress,h.inscriptionsContract.name,this.queryHoldingData.nftName,this.queryHoldingData.resolvedAddress,this.queryHoldingData.pageLimit,i);this.queryHoldingData.total=m.total,this.queryHoldingData.offset=m.offset,this.queryHoldingData.state=2,this.queryHoldingData.tableData.splice(0,this.queryHoldingData.tableData.length);let e=!1;for(const l of m.results){const r=l.value.repr.substring(1),c=this.queryHoldingData.resultCache[r];c?this.queryHoldingData.tableData.push(c):(e=!0,this.queryHoldingData.tableData.push({id:r,loadingState:0,block:0,dataType:"",dataLength:"",optInfo:{imageUrl:"",imageWidth:"",text:""}}))}(s||e&&this.queryHoldingData.total<=this.queryHoldingData.pageLimit)&&this.loadAllContent()},onClickChangePage(){this.queryHoldingPage(this.queryHoldingData.curPage)},async loadAllContent(){try{await this.realLoadAllContent()}finally{}},async realLoadAllContent(){this.bInRequestEncounterFail=!1,this.queryHoldingData.startLoadAllFlag++,this.queryHoldingData.curInRequestCount=0;let t=0;for(;!this.bInRequestEncounterFail&&t<this.queryHoldingData.tableData.length;)this.queryHoldingData.curInRequestCount<this.queryHoldingData.kMaxInRequestCount?(this.queryHoldingData.curInRequestCount++,this.loadInscription(this.queryHoldingData.startLoadAllFlag,t,this.queryHoldingData.tableData[t].id),++t):await new Promise(s=>setTimeout(s,1e3))},async loadInscription(t,s,i){const m=B(A(i));let e=this.queryHoldingData.tableData[s];try{e.loadingState=1;const r=await fetch(`${S.coreApiUrl}/v2/map_entry/${h.defaultContractAddress}/${h.inscriptionsContract.name}/map_inscriptions`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},proof:0,body:JSON.stringify(m)});if(t!=this.queryHoldingData.startLoadAllFlag)return;if(r.status==200){const c=await r.json(),u=z(c.data).value.data,v=Number(R(u.block)),f=R(u.type),C=u.payload.buffer,x=C.length;let p={imageUrl:null,text:null},H=!1;if(f.startsWith("image/")){p.imageUrl=window.URL.createObjectURL(new Blob([C],{type:f})),H=!0;var l=new Image;l.src=p.imageUrl;let k=this;l.onload=function(){t==k.queryHoldingData.startLoadAllFlag&&(e.loadingState=2,e.optInfo.imageWidth=Math.ceil(l.width*k.kFixImageHeight/l.height))}}else(f=="text"||f=="deploy-stx10")&&(p.text=new TextDecoder().decode(u.payload.buffer));H||(e.loadingState=2),e.id=i,e.block=v,e.dataType=f,e.dataLength=x,e.owner="",e.optInfo.imageUrl=p.imageUrl,e.optInfo.imageWidth=p.imageWidth,e.optInfo.text=p.text,this.queryHoldingData.resultCache[i]=e,this.queryHoldingData.curInRequestCount=Math.max(this.queryHoldingData.curInRequestCount-1,0)}else this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${i}, code=${r.status}, please try again 1 minute later.`)}catch(r){console.err(`loadInscription fail:${t},tableIndex:${s},id:${i},err:${r}`),this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${i}, please try again 1 minute later.`)}finally{e.loadingState=2}},async onClickTransferInscription(){const t=E.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{await this.readyTransferInscription()}finally{t.close()}},async readyTransferInscription(){const t=this.tranInsData.tokenId.trim(),s=await V.resolveAddress(this.tranInsData.address.trim());if(s.ret!=0){d.alert(s.errMsg);return}if(!d.parseAddress(s.value)){d.alertInvalidAddress();return}const i=await Y.queryNFTOwner(t);if(!i){d.alert(`Inscription #${t} not exist!`);return}if(i.toLowerCase()!=w().toLowerCase()){d.alert(`No permission! Owner of Inscription #${t} is <a style="color:white" href="https://explorer.hiro.so/address/${i}?chain=${L()}" target="_blank">${i}</a>`);return}if(i.toLowerCase()==s.value.toLowerCase()){d.alert("Receiver cann't be equal with current login address!");return}const m=[A(t),W(w()),d.parseAddress(s.value)],e="inscription",l=A(t),r=M(h.defaultContractAddress,h.inscriptionsContract.name,e),c=Z(w(),j.Sends,r,l),_={contractAddress:h.defaultContractAddress,contractName:h.inscriptionsContract.name,functionName:"transfer",functionArgs:m,network:S,appDetails:X(),postConditions:[c],onFinish:u=>{d.alert(`Transfer transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${u.txId}?chain=${L()}" target="_blank">Visit transaction.</a>`)}};O(_)}}},ee=t=>(G("data-v-c0fe147c"),t=t(),K(),t),te={id:"main"},ae=ee(()=>b("div",{id:"title"},"Tools",-1)),ne={id:"tip"},oe={key:0,style:{margin:"50px auto",width:"800px"}},se={class:"queryResultTxt"},le={key:0},ie={key:1},re={key:2},de=["src","width","height"],ue={key:3},ce={class:"queryResultTxt"};function ge(t,s,i,m,e,l){const r=g("el-input"),c=g("el-col"),_=g("el-button"),u=g("el-form-item"),v=g("router-link"),f=g("el-form"),C=g("el-tab-pane"),x=g("el-tabs"),p=g("el-table-column"),H=g("el-table"),k=g("el-pagination");return y(),D("div",te,[ae,a(x,{modelValue:e.activeTabName,"onUpdate:modelValue":s[3]||(s[3]=n=>e.activeTabName=n),size:"large"},{default:o(()=>[a(C,{label:"Query holdings",name:"query-holdings"},{default:o(()=>[a(f,{model:e.queryHoldingData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[a(u,{label:"address"},{default:o(()=>[a(c,{span:14},{default:o(()=>[a(r,{modelValue:e.queryHoldingData.address,"onUpdate:modelValue":s[0]||(s[0]=n=>e.queryHoldingData.address=n),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1}),e.bSignedIn?(y(),T(c,{key:0,span:4},{default:o(()=>[a(_,{style:{"margin-left":"4px"},type:"primary",plain:"",onClick:l.onClickFillAddress},{default:o(()=>[q("Fill current account")]),_:1},8,["onClick"])]),_:1})):I("",!0)]),_:1}),a(u,null,{default:o(()=>[a(_,{type:"primary",onClick:l.onClickQueryHoldings,loading:e.queryHoldingData.state==1,disabled:!l.queryHoldingsBtnValid},{default:o(()=>[q("Query")]),_:1},8,["onClick","loading","disabled"])]),_:1}),a(u,null,{default:o(()=>[b("div",ne,[q("Tips: can query stx10 balance in "),a(v,{id:"tipLink",to:{path:"/stx10",query:{tab:"query-balance"}},replace:""},{default:o(()=>[q("stx10")]),_:1}),q(" menu. ")])]),_:1})]),_:1},8,["model"])]),_:1}),a(C,{label:"Transfer inscription",name:"transfer-inscription"},{default:o(()=>[a(f,{model:e.tranInsData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[a(u,{label:"inscription id"},{default:o(()=>[a(c,{span:14},{default:o(()=>[a(r,{modelValue:e.tranInsData.tokenId,"onUpdate:modelValue":s[1]||(s[1]=n=>e.tranInsData.tokenId=n),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),a(u,{label:"address"},{default:o(()=>[a(c,{span:14},{default:o(()=>[a(r,{modelValue:e.tranInsData.address,"onUpdate:modelValue":s[2]||(s[2]=n=>e.tranInsData.address=n),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1})]),_:1}),a(u,null,{default:o(()=>[a(_,{type:"primary",onClick:l.onClickTransferInscription,disabled:!l.transferInsBtnValid},{default:o(()=>[q(N(e.bSignedIn?"Transfer":"Sign in to transfer"),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),e.activeTabName=="query-holdings"&&e.queryHoldingData.state==2?(y(),D("div",oe,[e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),T(_,{key:0,type:"primary",size:"large",onClick:l.loadAllContent},{default:o(()=>[q("Load content")]),_:1},8,["onClick"])):I("",!0),a(H,{size:"small",data:e.queryHoldingData.tableData,"empty-text":"No inscriptions"},{default:o(()=>[a(p,{label:"Inscription #",width:"110"},{default:o(n=>[b("div",se,N(n.row.id),1)]),_:1}),a(p,{label:"Content"},{default:o(n=>[b("div",null,[n.row.loadingState==1?(y(),D("div",le,"loading..")):I("",!0),n.row.loadingState==2&&(n.row.dataType=="text"||n.row.dataType=="deploy-stx10")?(y(),D("div",ie,[a(r,{modelValue:n.row.optInfo.text,"onUpdate:modelValue":F=>n.row.optInfo.text=F,readonly:"",type:"textarea",autosize:{minRows:1,maxRows:3},resize:"none"},null,8,["modelValue","onUpdate:modelValue"])])):n.row.loadingState==2&&n.row.dataType.startsWith("image/")?(y(),D("div",re,[b("img",{src:n.row.optInfo.imageUrl,width:n.row.optInfo.imageWidth,height:e.kFixImageHeight,alt:""},null,8,de)])):n.row.loadingState==2?(y(),D("div",ue," Not support preview yet. ")):I("",!0)])]),_:1}),a(p,{label:"Content type",width:"150"},{default:o(n=>[b("div",ce,N(n.row.dataType),1)]),_:1})]),_:1},8,["data"]),e.queryHoldingData.state==2&&e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),T(k,{key:1,style:{"margin-top":"16px"},layout:"total, prev, pager, next","default-page-size":e.queryHoldingData.pageLimit,"current-page":e.queryHoldingData.curPage,"onUpdate:currentPage":s[4]||(s[4]=n=>e.queryHoldingData.curPage=n),total:e.queryHoldingData.total,onCurrentChange:l.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):I("",!0)])):I("",!0)])}const me=U($,[["render",ge],["__scopeId","data-v-c0fe147c"]]);export{me as default};
