import{a as F,U as d,A as U,G as k,j as P,u as x,k as B,E as z,i as V,L as E,K as W,N as M,I as j,b as g,o as p,c as q,f as n,w as s,q as A,g as D,s as O,v as Q,m as v,t as T,d as b,p as J,h as G,J as K}from"./index-182338ec.js";import{c as L,C as X,d as Y}from"./ContractHelper-446c0bc4.js";import{C as N}from"./ChainHelper-b1ce6927.js";const R=O(),y=Q(),Z={name:"ToolsPage",components:{},data(){return{u:d,bSignedIn:U.isUserSignedIn(),kFixImageHeight:128,defaultReadonlyAddress:y.defaultContractAddress,activeTabName:"query-holdings",queryHoldingData:{address:"",resolvedAddress:"",nftName:"inscription",state:0,pageLimit:25,total:0,curPage:1,resultCache:{},tableData:[],bInRequestEncounterFail:!1,startLoadAllFlag:0,curInRequestCount:0,kMaxInRequestCount:10},tranInsData:{tokenId:"",address:""}}},computed:{queryHoldingsBtnValid(){return this.queryHoldingData.address.trim().length>0},transferInsBtnValid(){return this.bSignedIn&&/^[0-9]{1,16}$/.test(this.tranInsData.tokenId.trim())&&this.tranInsData.address.trim().length>0}},async mounted(){},methods:{onClickFillAddress(){this.queryHoldingData.address=k()},async onClickQueryHoldings(){this.queryHoldingData.state=1;const t=await N.resolveAddress(this.queryHoldingData.address.trim());if(t.ret!=0){this.queryHoldingData.state=0,d.alert(t.errMsg);return}if(!d.parseAddress(t.value)){this.queryHoldingData.state=0,d.alertInvalidAddress();return}this.queryHoldingData.resolvedAddress=t.value,this.queryHoldingPage(1,!0)},async queryHoldingPage(t,o){this.queryHoldingData.state=1;const r=(t-1)*this.queryHoldingData.pageLimit,h=await N.getNFTHoldings(y.defaultContractAddress,y.inscriptionsContract.name,this.queryHoldingData.nftName,this.queryHoldingData.resolvedAddress,this.queryHoldingData.pageLimit,r);this.queryHoldingData.total=h.total,this.queryHoldingData.offset=h.offset,this.queryHoldingData.state=2,this.queryHoldingData.tableData.splice(0,this.queryHoldingData.tableData.length);let e=!1;for(const l of h.results){const i=l.value.repr.substring(1),c=this.queryHoldingData.resultCache[i];c?this.queryHoldingData.tableData.push(c):(e=!0,this.queryHoldingData.tableData.push({id:i,loadingState:0,block:0,dataType:"",dataLength:"",optInfo:{imageUrl:"",imageWidth:"",text:""}}))}(o||e&&this.queryHoldingData.total<=this.queryHoldingData.pageLimit)&&this.loadAllContent()},onClickChangePage(){this.queryHoldingPage(this.queryHoldingData.curPage)},async loadAllContent(){try{await this.realLoadAllContent()}finally{}},async realLoadAllContent(){this.bInRequestEncounterFail=!1,this.queryHoldingData.startLoadAllFlag++,this.queryHoldingData.curInRequestCount=0;let t=0;for(;!this.bInRequestEncounterFail&&t<this.queryHoldingData.tableData.length;)this.queryHoldingData.curInRequestCount<this.queryHoldingData.kMaxInRequestCount?(this.queryHoldingData.curInRequestCount++,this.loadInscription(this.queryHoldingData.startLoadAllFlag,t,this.queryHoldingData.tableData[t].id),++t):await new Promise(o=>setTimeout(o,1e3))},async loadInscription(t,o,r){const h=P(x(r));let e=this.queryHoldingData.tableData[o];try{e.loadingState=1;const i=await fetch(`${R.coreApiUrl}/v2/map_entry/${y.defaultContractAddress}/${y.inscriptionsContract.name}/map_inscriptions`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},proof:0,body:JSON.stringify(h)});if(t!=this.queryHoldingData.startLoadAllFlag)return;if(i.status==200){const c=await i.json(),u=B(c.data).value.data,C=Number(L(u.block)),m=L(u.type),H=u.payload.buffer,I=H.length;let f={imageUrl:null,text:null},w=!1;if(m.startsWith("image/")){f.imageUrl=window.URL.createObjectURL(new Blob([H],{type:m})),w=!0;var l=new Image;l.src=f.imageUrl;let a=this;l.onload=function(){t==a.queryHoldingData.startLoadAllFlag&&(e.loadingState=2,e.optInfo.imageWidth=Math.ceil(l.width*a.kFixImageHeight/l.height))}}else(m=="text"||m=="deploy-stx10")&&(f.text=new TextDecoder().decode(u.payload.buffer));w||(e.loadingState=2),e.id=r,e.block=C,e.dataType=m,e.dataLength=I,e.owner="",e.optInfo.imageUrl=f.imageUrl,e.optInfo.imageWidth=f.imageWidth,e.optInfo.text=f.text,this.queryHoldingData.resultCache[r]=e,this.queryHoldingData.curInRequestCount=Math.max(this.queryHoldingData.curInRequestCount-1,0)}else this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${r}, code=${i.status}, please try again 1 minute later.`)}catch(i){console.err(`loadInscription fail:${t},tableIndex:${o},id:${r},err:${i}`),this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${r}, please try again 1 minute later.`)}finally{e.loadingState=2}},async onClickTransferInscription(){const t=z.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{await this.readyTransferInscription()}finally{t.close()}},async readyTransferInscription(){const t=this.tranInsData.tokenId.trim(),o=await N.resolveAddress(this.tranInsData.address.trim());if(o.ret!=0){d.alert(o.errMsg);return}if(!d.parseAddress(o.value)){d.alertInvalidAddress();return}const r=await X.queryNFTOwner(t);if(!r){d.alert(`Inscription #${t} not exist!`);return}if(r.toLowerCase()!=k().toLowerCase()){d.alert(`No permission! Owner of Inscription #${t} is <a style="color:white" href="https://explorer.hiro.so/address/${r}?chain=${V()}" target="_blank">${r}</a>`);return}if(r.toLowerCase()==o.value.toLowerCase()){d.alert("Receiver cann't be equal with current login address!");return}const h=[x(t),E(k()),d.parseAddress(o.value)],e="inscription",l=x(t),i=W(y.defaultContractAddress,y.inscriptionsContract.name,e),c=Y(k(),M.Sends,i,l),_={contractAddress:y.defaultContractAddress,contractName:y.inscriptionsContract.name,functionName:"transfer",functionArgs:h,network:R,appDetails:K(),postConditions:[c],onFinish:u=>{d.alert(`Transfer transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${u.txId}?chain=${V()}" target="_blank">Visit transaction.</a>`)}};j(_)}}},$=t=>(J("data-v-7cb5a31c"),t=t(),G(),t),ee={id:"main"},te=$(()=>b("div",{id:"title"},"Tools",-1)),ae={key:0,style:{margin:"50px auto",width:"800px"}},ne={class:"queryResultTxt"},oe={key:0},se={key:1},le={key:2},re=["src","width","height"],ie={key:3},de={class:"queryResultTxt"};function ue(t,o,r,h,e,l){const i=g("el-input"),c=g("el-col"),_=g("el-button"),u=g("el-form-item"),C=g("el-form"),m=g("el-tab-pane"),H=g("el-tabs"),I=g("el-table-column"),f=g("el-table"),w=g("el-pagination");return p(),q("div",ee,[te,n(H,{modelValue:e.activeTabName,"onUpdate:modelValue":o[3]||(o[3]=a=>e.activeTabName=a),size:"large"},{default:s(()=>[n(m,{label:"Query holdings",name:"query-holdings"},{default:s(()=>[n(C,{model:e.queryHoldingData,"label-width":"100px",class:"tabInner",size:"large"},{default:s(()=>[n(u,{label:"address"},{default:s(()=>[n(c,{span:14},{default:s(()=>[n(i,{modelValue:e.queryHoldingData.address,"onUpdate:modelValue":o[0]||(o[0]=a=>e.queryHoldingData.address=a),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1}),e.bSignedIn?(p(),A(c,{key:0,span:4},{default:s(()=>[n(_,{style:{"margin-left":"4px"},type:"primary",plain:"",onClick:l.onClickFillAddress},{default:s(()=>[v("Fill current account")]),_:1},8,["onClick"])]),_:1})):D("",!0)]),_:1}),n(u,null,{default:s(()=>[n(_,{type:"primary",onClick:l.onClickQueryHoldings,loading:e.queryHoldingData.state==1,disabled:!l.queryHoldingsBtnValid},{default:s(()=>[v("Query")]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),n(m,{label:"Transfer inscription",name:"transfer-inscription"},{default:s(()=>[n(C,{model:e.tranInsData,"label-width":"100px",class:"tabInner",size:"large"},{default:s(()=>[n(u,{label:"inscription id"},{default:s(()=>[n(c,{span:14},{default:s(()=>[n(i,{modelValue:e.tranInsData.tokenId,"onUpdate:modelValue":o[1]||(o[1]=a=>e.tranInsData.tokenId=a),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(u,{label:"address"},{default:s(()=>[n(c,{span:14},{default:s(()=>[n(i,{modelValue:e.tranInsData.address,"onUpdate:modelValue":o[2]||(o[2]=a=>e.tranInsData.address=a),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1})]),_:1}),n(u,null,{default:s(()=>[n(_,{type:"primary",onClick:l.onClickTransferInscription,disabled:!l.transferInsBtnValid},{default:s(()=>[v(T(e.bSignedIn?"Transfer":"Sign in to transfer"),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),e.activeTabName=="query-holdings"&&e.queryHoldingData.state==2?(p(),q("div",ae,[e.queryHoldingData.total>e.queryHoldingData.pageLimit?(p(),A(_,{key:0,type:"primary",size:"large",onClick:l.loadAllContent},{default:s(()=>[v("Load content")]),_:1},8,["onClick"])):D("",!0),n(f,{size:"small",data:e.queryHoldingData.tableData,"empty-text":"No inscriptions"},{default:s(()=>[n(I,{label:"Inscription #",width:"110"},{default:s(a=>[b("div",ne,T(a.row.id),1)]),_:1}),n(I,{label:"Content"},{default:s(a=>[b("div",null,[a.row.loadingState==1?(p(),q("div",oe,"loading..")):D("",!0),a.row.loadingState==2&&(a.row.dataType=="text"||a.row.dataType=="deploy-stx10")?(p(),q("div",se,[n(i,{modelValue:a.row.optInfo.text,"onUpdate:modelValue":S=>a.row.optInfo.text=S,readonly:"",type:"textarea",autosize:{minRows:1,maxRows:3},resize:"none"},null,8,["modelValue","onUpdate:modelValue"])])):a.row.loadingState==2&&a.row.dataType.startsWith("image/")?(p(),q("div",le,[b("img",{src:a.row.optInfo.imageUrl,width:a.row.optInfo.imageWidth,height:e.kFixImageHeight,alt:""},null,8,re)])):a.row.loadingState==2?(p(),q("div",ie," Not support preview yet. ")):D("",!0)])]),_:1}),n(I,{label:"Content type",width:"150"},{default:s(a=>[b("div",de,T(a.row.dataType),1)]),_:1})]),_:1},8,["data"]),e.queryHoldingData.state==2&&e.queryHoldingData.total>e.queryHoldingData.pageLimit?(p(),A(w,{key:1,style:{"margin-top":"16px"},layout:"total, prev, pager, next","default-page-size":e.queryHoldingData.pageLimit,"current-page":e.queryHoldingData.curPage,"onUpdate:currentPage":o[4]||(o[4]=a=>e.queryHoldingData.curPage=a),total:e.queryHoldingData.total,onCurrentChange:l.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):D("",!0)])):D("",!0)])}const ye=F(Z,[["render",ue],["__scopeId","data-v-7cb5a31c"]]);export{ye as default};
