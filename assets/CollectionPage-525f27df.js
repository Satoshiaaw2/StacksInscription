import{_,a as p,o as r,c as l,e as I,w as k,b as g,t as u,q as w,U as y,m as b,f as h,F as C,d as D,s as x}from"./index-dbfefb31.js";import"./ContractHelper-8fd09c24.js";import{s as f}from"./supabase-71dcdca6.js";import"./browser-ponyfill-45c4606e.js";const M={name:"CollectionInscriptionItem",props:["inscData"],async mounted(){}},v={class:"textArea"},T={key:0},P=["src","width","height"],S={key:2},U={class:"inscNo"};function L(s,o,t,i,e,a){const n=p("el-card");return r(),l("div",null,[I(n,{"body-style":{padding:"0px"},id:"insc",shadow:"hover"},{default:k(()=>[g("div",v,[t.inscData.dataType=="text"||t.inscData.dataType=="deploy-stx10"?(r(),l("div",T,u(t.inscData.optInfo.text),1)):t.inscData.dataType.startsWith("image/")?(r(),l("img",{key:1,src:t.inscData.optInfo.imageUrl,width:t.inscData.optInfo.imageWidth,height:t.inscData.optInfo.imageHeight,class:w({nn:t.inscData.optInfo.originImageWidth<=64&&t.inscData.optInfo.originImageHeight<=64&&t.inscData.optInfo.originImageWidth>0&&t.inscData.optInfo.originImageHeight>0}),alt:""},null,10,P)):(r(),l("span",S,"Parse error"))]),g("div",U," #"+u(t.inscData.id),1)]),_:1})])}const F=_(M,[["render",L],["__scopeId","data-v-55c89441"]]);const R={name:"CollectionDetailPage",components:{CollectionInscriptionItem:F},data(){return{kFixImageHeight:400,collectionId:"",collectionName:"",loading:null,summary:{id:"",name:"",iconUrl:"",rangeStart:0,rangeEnd:0,detail:"",shortDetail:"",showMoreMode:0,website:"",twitter:"",discord:"",telegram:"",priority:0,idList:[]},totalInscriptionCount:0,curPage:1,kMaxImageLen:236,kPageSize:50,asyncInfo:{id:0,kMaxInRequestCount:15,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0},tableData:[],asyncInfo:{id:0,kMaxInRequestCount:8,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0}}},async mounted(){if(!this.$route.params.hasOwnProperty("id"))return;const s=this.$route.params.id;!s||s.length==0||(this.collectionId=s,this.loadCollectionDB(s),this.loadCollectionStorage(s))},methods:{async loadCollectionDB(s){const{data:o,error:t,status:i}=await f.from("collection").select("*").eq("id",s).limit(1);if(i==200&&!t&&o.length==1){const e=o[0];let a=this.summary;a.id=e.id,a.name=e.name,a.iconUrl=e.iconurl,a.rangeStart=e.startno,a.rangeEnd=e.endno,a.detail=e.detail,a.website=e.website,a.twitter=e.twitter,a.discord=e.discord,a.telegram=e.telegram,a.priority=e.priority,this.updateToggleFoldData()}else console.log("Load collection fail, status:",i,"error: ",t),y.alert("Load collection fail, please try later")},async loadCollectionStorage(s){const{data:o,error:t}=await f.storage.from("collection").download(s);if(t){y.alert("Load storage fail, please try later");return}const i=await o.text(),a=JSON.parse(i).split(",");this.summary.idList=[];for(const n of a)this.summary.idList.push(parseInt(n));this.totalInscriptionCount=this.summary.idList.length,this.showPage(1)},async showPage(s){this.curPage=s;let o=[];const t=(s-1)*this.kPageSize,i=Math.min(t+this.kPageSize,this.summary.idList.length);for(let c=t;c<i;c++){const m=this.summary.idList[c];o.push(m)}const{data:e,error:a,status:n}=await f.from("inscriptions").select("id, type, payload").order("id",{ascending:!0}).in("id",o).limit(this.kPageSize);n==200&&!a?this.setTableData(e):(console.log("showPage error:",s,a),y.alert("Load error, please try again later"))},setTableData(s){let o=[];this.tableData.splice(0,this.tableData.length);for(let t=0;t<s.length;t++){const i=s[t];let e={key:i.id,id:i.id,block:i.block,dataType:i.type,owner:"",payload:"",optInfo:{imageUrl:"",imageWidth:"",imageHeight:this.kMaxImageLen,originImageWidth:0,originImageHeight:0,text:""}};if(e.dataType=="text"||e.dataType=="deploy-stx10")e.payload=i.payload,e.optInfo.text=i.payload;else{const a=i.payload.split("_*|");a.length==3&&a[1].endsWith(`_${e.id}`)?o.push({index:t,inscData:e,syncUrl:a[1]}):console.log("setTableData error",a,e)}this.tableData.push(e)}this.syncTable(o)},async syncTable(s){if(!s||s.length==0)return;let o=this.asyncInfo.id+1;this.asyncInfo.id=o,this.asyncInfo.curInRequestCount=0,this.asyncInfo.retryTimes=0,this.asyncInfo.bFailFlag=!1;let t=0;for(;o==this.asyncInfo.id&&!this.asyncInfo.bFailFlag&&t<s.length;)this.asyncInfo.curInRequestCount<this.asyncInfo.kMaxInRequestCount?(++this.asyncInfo.curInRequestCount,this.syncOne(o,s[t++])):await new Promise(i=>setTimeout(i,1e3))},async syncOne(s,o){const t=o.inscData;let i=null,e=!1;for(;;){const n=localStorage.getItem(o.syncUrl);if(n){i=y.base64ToBlob(n,"text/plain");break}const{data:c,error:m}=await f.storage.from("payload").download(o.syncUrl);if(s!=this.asyncInfo.id)return;if(m){if(++this.asyncInfo.retryTimes>this.asyncInfo.kMaxRetryTimes){this.asyncInfo.bFailFlag=!0;return}await new Promise(d=>setTimeout(d,5e3))}i=c,e=!0;break}if(t.payload=i,t.dataType.startsWith("image/")){t.optInfo.imageUrl=window.URL.createObjectURL(new Blob([i],{type:t.dataType}));var a=new Image;a.src=t.optInfo.imageUrl;let n=this;a.onload=function(){t.optInfo.originImageWidth=a.width,t.optInfo.originImageHeight=a.height,a.width>a.height?(t.optInfo.imageWidth=n.kMaxImageLen,t.optInfo.imageHeight=Math.ceil(a.height*n.kMaxImageLen/a.width)):(t.optInfo.imageHeight=n.kMaxImageLen,t.optInfo.imageWidth=Math.ceil(a.width*n.kMaxImageLen/a.height)),t.key*=-1,n.$forceUpdate()},e&&y.blobToBase64(i,function(c){try{localStorage.setItem(o.syncUrl,c)}catch(m){m.toString().includes("exceeded the quota")&&(console.log("exceeded the quota, purge"),localStorage.clear())}})}this.asyncInfo.curInRequestCount=Math.max(this.asyncInfo.curInRequestCount-1,0)},async onClickChangePage(){this.showPage(this.curPage)},onClickItem(s){const o=this.tableData[s],t=this.$router.resolve({path:`/inscription/${o.id}`});window.open(t.href,"_blank")},updateToggleFoldData(){this.summary.shortDetail="",this.summary.showMoreMode=0;const s=250;if(this.summary.detail.length>s){let o=s;for(let t=s;t<s+20;t++)if(this.summary.detail.substr(t,1)==" "){o=t;break}this.summary.shortDetail=this.summary.detail.substr(0,o)+"...",this.summary.showMoreMode=1}},toggleShowMore(){this.summary.showMoreMode=this.summary.showMoreMode==1?2:1}}},q={id:"main"},W={key:0,id:"summaryArea"},B={id:"title"},N={id:"rangeArea"},z={id:"desc"},H={id:"linkUrls"},V=["href"],A=["href"],E=["href"],O=["href"],j={key:1,id:"memberArea"},J=["onClick"];function G(s,o,t,i,e,a){const n=p("el-avatar"),c=p("CollectionInscriptionItem"),m=p("el-pagination");return r(),l("div",q,[e.summary.name.length>0?(r(),l("div",W,[I(n,{shape:"circle",size:100,src:e.summary.iconUrl},null,8,["src"]),g("div",B,u(e.summary.name),1),g("div",N,"#"+u(e.summary.rangeStart)+" - #"+u(e.summary.rangeEnd),1),g("div",z,[b(u(e.summary.showMoreMode==1?e.summary.shortDetail:e.summary.detail)+" ",1),e.summary.showMoreMode!=0?(r(),l("button",{key:0,onClick:o[0]||(o[0]=(...d)=>a.toggleShowMore&&a.toggleShowMore(...d)),id:"showMoreBtn"},u(e.summary.showMoreMode==1?"Show more":"Show less"),1)):h("",!0)]),g("div",H,[e.summary.website.length>0?(r(),l("a",{key:0,href:e.summary.website,target:"_blank",class:"linkUrl"},"Website",8,V)):h("",!0),e.summary.twitter.length>0?(r(),l("a",{key:1,href:e.summary.twitter,target:"_blank",class:"linkUrl"},"Twitter",8,A)):h("",!0),e.summary.discord.length>0?(r(),l("a",{key:2,href:e.summary.discord,target:"_blank",class:"linkUrl"},"Discord",8,E)):h("",!0),e.summary.telegram.length>0?(r(),l("a",{key:3,href:e.summary.telegram,target:"_blank",class:"linkUrl"},"Telegram",8,O)):h("",!0)])])):h("",!0),e.tableData.length>0?(r(),l("div",j,[(r(!0),l(C,null,D(e.tableData.length,d=>(r(),l("button",{key:e.tableData[d-1].key,class:"member",onClick:K=>a.onClickItem(d-1)},[I(c,{inscData:e.tableData[d-1]},null,8,["inscData"])],8,J))),128))])):h("",!0),e.tableData.length>0?(r(),x(m,{key:2,style:{margin:"32px auto"},layout:"total, prev, pager, next, jumper","default-page-size":e.kPageSize,"current-page":e.curPage,"onUpdate:currentPage":o[1]||(o[1]=d=>e.curPage=d),total:e.totalInscriptionCount,onCurrentChange:a.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):h("",!0)])}const $=_(R,[["render",G],["__scopeId","data-v-1e8340b6"]]);export{$ as default};
