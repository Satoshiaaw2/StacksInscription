import{_ as I,a as y,o as n,c as r,e as f,w,b as u,t as m,U as _,m as k,f as c,F as b,d as C,s as D}from"./index-2946e483.js";import"./ContractHelper-e9562618.js";import{s as g}from"./supabase-99bd82aa.js";import"./browser-ponyfill-532a798f.js";const M={name:"CollectionInscriptionItem",props:["inscData"],async mounted(){}},x={class:"textArea"},v={key:0},T=["src","width","height"],P={key:2},L={class:"inscNo"};function U(s,o,t,i,e,a){const l=y("el-card");return n(),r("div",null,[f(l,{"body-style":{padding:"0px"},id:"insc",shadow:"hover"},{default:w(()=>[u("div",x,[t.inscData.dataType=="text"||t.inscData.dataType=="deploy-stx10"?(n(),r("div",v,m(t.inscData.optInfo.text),1)):t.inscData.dataType.startsWith("image/")?(n(),r("img",{key:1,class:"img",src:t.inscData.optInfo.imageUrl,width:t.inscData.optInfo.imageWidth,height:t.inscData.optInfo.imageHeight,alt:""},null,8,T)):(n(),r("span",P,"Parse error"))]),u("div",L," #"+m(t.inscData.id),1)]),_:1})])}const S=I(M,[["render",U],["__scopeId","data-v-ea173e7c"]]);const F={name:"CollectionDetailPage",components:{CollectionInscriptionItem:S},data(){return{kFixImageHeight:400,collectionId:"",collectionName:"",loading:null,summary:{id:"",name:"",iconUrl:"",rangeStart:0,rangeEnd:0,detail:"",shortDetail:"",showMoreMode:0,website:"",twitter:"",discord:"",telegram:"",priority:0,idList:[]},totalInscriptionCount:0,curPage:1,kMaxImageLen:236,kPageSize:25,asyncInfo:{id:0,kMaxInRequestCount:10,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0},tableData:[],asyncInfo:{id:0,kMaxInRequestCount:8,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0}}},async mounted(){if(!this.$route.params.hasOwnProperty("id"))return;const s=this.$route.params.id;!s||s.length==0||(this.collectionId=s,this.loadCollectionDB(s),this.loadCollectionStorage(s))},methods:{async loadCollectionDB(s){const{data:o,error:t,status:i}=await g.from("collection").select("*").eq("id",s).limit(1);if(i==200&&!t&&o.length==1){const e=o[0];let a=this.summary;a.id=e.id,a.name=e.name,a.iconUrl=e.iconurl,a.rangeStart=e.startno,a.rangeEnd=e.endno,a.detail=e.detail,a.website=e.website,a.twitter=e.twitter,a.discord=e.discord,a.telegram=e.telegram,a.priority=e.priority,console.log("loadCollectionDB",a),this.updateToggleFoldData()}else console.log("Load collection fail, status:",i,"error: ",t),_.alert("Load collection fail, please try later")},async loadCollectionStorage(s){const{data:o,error:t}=await g.storage.from("collection").download(s);if(t){_.alert("Load storage fail, please try later");return}const i=await o.text(),a=JSON.parse(i).split(",");this.summary.idList=[];for(const l of a)this.summary.idList.push(parseInt(l));this.totalInscriptionCount=this.summary.idList.length,this.showPage(1)},async showPage(s){this.curPage=s;let o=[];const t=(s-1)*this.kPageSize,i=Math.min(t+this.kPageSize,this.summary.idList.length);for(let d=t;d<i;d++){const p=this.summary.idList[d];o.push(p)}const{data:e,error:a,status:l}=await g.from("inscriptions").select("id, type, payload").order("id",{ascending:!0}).in("id",o).limit(this.kPageSize);l==200&&!a?this.setTableData(e):(console.log("showPage error:",s,a),_.alert("Load error, please try again later"))},setTableData(s){let o=[];this.tableData.splice(0,this.tableData.length);for(let t=0;t<s.length;t++){const i=s[t];let e={key:i.id,id:i.id,block:i.block,dataType:i.type,owner:"",payload:"",optInfo:{imageUrl:"",imageWidth:"",imageHeight:this.kMaxImageLen,originImageWidth:0,originImageHeight:0,text:""}};if(e.dataType=="text"||e.dataType=="deploy-stx10")e.payload=i.payload,e.optInfo.text=i.payload;else{const a=i.payload.split("_*|");a.length==3&&a[1].endsWith(`_${e.id}`)?o.push({index:t,inscData:e,syncUrl:a[1]}):console.log("setTableData error",a,e)}this.tableData.push(e)}this.syncTable(o)},async syncTable(s){if(!s||s.length==0)return;let o=this.asyncInfo.id+1;this.asyncInfo.id=o,this.asyncInfo.curInRequestCount=0,this.asyncInfo.retryTimes=0,this.asyncInfo.bFailFlag=!1;let t=0;for(;o==this.asyncInfo.id&&!this.asyncInfo.bFailFlag&&t<s.length;)this.asyncInfo.curInRequestCount<this.asyncInfo.kMaxInRequestCount?(++this.asyncInfo.curInRequestCount,this.syncOne(o,s[t++])):await new Promise(i=>setTimeout(i,1e3))},async syncOne(s,o){const t=o.inscData;let i=null;for(;;){const{data:a,error:l}=await g.storage.from("payload").download(o.syncUrl);if(s!=this.asyncInfo.id)return;if(l){if(++this.asyncInfo.retryTimes>this.asyncInfo.kMaxRetryTimes){this.asyncInfo.bFailFlag=!0;return}await new Promise(d=>setTimeout(d,5e3))}i=a;break}if(t.payload=i,t.dataType.startsWith("image/")){t.optInfo.imageUrl=window.URL.createObjectURL(new Blob([i],{type:t.dataType}));var e=new Image;e.src=t.optInfo.imageUrl;let a=this;e.onload=function(){t.optInfo.originImageWidth=e.width,t.optInfo.originImageHeight=e.height,e.width>e.height?(t.optInfo.imageWidth=a.kMaxImageLen,t.optInfo.imageHeight=Math.ceil(e.height*a.kMaxImageLen/e.width)):(t.optInfo.imageHeight=a.kMaxImageLen,t.optInfo.imageWidth=Math.ceil(e.width*a.kMaxImageLen/e.height)),t.key*=-1,a.$forceUpdate()}}this.asyncInfo.curInRequestCount=Math.max(this.asyncInfo.curInRequestCount-1,0)},async onClickChangePage(){this.showPage(this.curPage)},onClickItem(s){const o=this.tableData[s],t=this.$router.resolve({path:`/inscription/${o.id}`});window.open(t.href,"_blank")},updateToggleFoldData(){this.summary.shortDetail="",this.summary.showMoreMode=0;const s=250;if(this.summary.detail.length>s){let o=s;for(let t=s;t<s+20;t++)if(this.summary.detail.substr(t,1)==" "){o=t;break}this.summary.shortDetail=this.summary.detail.substr(0,o)+"...",this.summary.showMoreMode=1}},toggleShowMore(){this.summary.showMoreMode=this.summary.showMoreMode==1?2:1,console.log("___showMoreMode: ",this.summary.showMoreMode)}}},R={id:"main"},q={key:0,id:"summaryArea"},W={id:"title"},B={id:"rangeArea"},N={id:"desc"},z={id:"linkUrls"},H=["href"],V=["href"],A=["href"],E=["href"],O={key:1,id:"memberArea"},j=["onClick"];function J(s,o,t,i,e,a){const l=y("el-avatar"),d=y("CollectionInscriptionItem"),p=y("el-pagination");return n(),r("div",R,[e.summary.name.length>0?(n(),r("div",q,[f(l,{shape:"circle",size:100,src:e.summary.iconUrl},null,8,["src"]),u("div",W,m(e.summary.name),1),u("div",B,"#"+m(e.summary.rangeStart)+" - #"+m(e.summary.rangeEnd),1),u("div",N,[k(m(e.summary.showMoreMode==1?e.summary.shortDetail:e.summary.detail)+" ",1),e.summary.showMoreMode!=0?(n(),r("button",{key:0,onClick:o[0]||(o[0]=(...h)=>a.toggleShowMore&&a.toggleShowMore(...h)),id:"showMoreBtn"},m(e.summary.showMoreMode==1?"Show more":"Show less"),1)):c("",!0)]),u("div",z,[e.summary.website.length>0?(n(),r("a",{key:0,href:e.summary.website,target:"_blank",class:"linkUrl"},"Website",8,H)):c("",!0),e.summary.twitter.length>0?(n(),r("a",{key:1,href:e.summary.twitter,target:"_blank",class:"linkUrl"},"Twitter",8,V)):c("",!0),e.summary.discord.length>0?(n(),r("a",{key:2,href:e.summary.discord,target:"_blank",class:"linkUrl"},"Discord",8,A)):c("",!0),e.summary.telegram.length>0?(n(),r("a",{key:3,href:e.summary.telegram,target:"_blank",class:"linkUrl"},"Telegram",8,E)):c("",!0)])])):c("",!0),e.tableData.length>0?(n(),r("div",O,[(n(!0),r(b,null,C(e.tableData.length,h=>(n(),r("button",{key:e.tableData[h-1].key,class:"member",onClick:G=>a.onClickItem(h-1)},[f(d,{inscData:e.tableData[h-1]},null,8,["inscData"])],8,j))),128))])):c("",!0),e.tableData.length>0?(n(),D(p,{key:2,style:{margin:"32px auto"},layout:"total, prev, pager, next, jumper","default-page-size":e.kPageSize,"current-page":e.curPage,"onUpdate:currentPage":o[1]||(o[1]=h=>e.curPage=h),total:e.totalInscriptionCount,onCurrentChange:a.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):c("",!0)])}const Z=I(F,[["render",J],["__scopeId","data-v-22a2fcb5"]]);export{Z as default};
