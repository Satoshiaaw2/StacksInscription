import{a as U,U as d,A as P,G as w,j as B,u as T,k as z,E,i as L,L as Q,K as W,N as M,I as j,b as g,o as y,c as b,f as n,w as o,q as v,g as q,s as O,v as J,m as D,d as I,t as N,p as G,h as K,J as X}from"./index-5821ddc0.js";import{c as F,C as Y,d as Z}from"./ContractHelper-2bcc4442.js";import{C as V}from"./ChainHelper-41c6f24c.js";const R=O(),h=J(),$={name:"ToolsPage",components:{},data(){return{u:d,bSignedIn:P.isUserSignedIn(),kFixImageHeight:128,defaultReadonlyAddress:h.defaultContractAddress,activeTabName:"query-holdings",queryHoldingData:{address:"",resolvedAddress:"",nftName:"inscription",state:0,pageLimit:25,total:0,curPage:1,resultCache:{},tableData:[],bInRequestEncounterFail:!1,startLoadAllFlag:0,curInRequestCount:0,kMaxInRequestCount:10,bClickQueryHoldingsFlag:!1},tranInsData:{tokenId:"",address:""}}},computed:{queryHoldingsBtnValid(){return this.queryHoldingData.address.trim().length>0},transferInsBtnValid(){return this.bSignedIn&&/^[0-9]{1,16}$/.test(this.tranInsData.tokenId.trim())&&this.tranInsData.address.trim().length>0}},async mounted(){},methods:{onClickFillAddress(){this.queryHoldingData.address=w()},async onClickQueryHoldings(){this.queryHoldingData.bClickQueryHoldingsFlag=!0,this.queryHoldingData.state=1;const t=await V.resolveAddress(this.queryHoldingData.address.trim());if(t.ret!=0){this.queryHoldingData.state=0,d.alert(t.errMsg);return}if(!d.parseAddress(t.value)){this.queryHoldingData.state=0,d.alertInvalidAddress();return}this.queryHoldingData.resolvedAddress=t.value,this.queryHoldingPage(1,!0)},async queryHoldingPage(t,s){this.queryHoldingData.state=1;const i=(t-1)*this.queryHoldingData.pageLimit,m=await V.getNFTHoldings(h.defaultContractAddress,h.inscriptionsContract.name,this.queryHoldingData.nftName,this.queryHoldingData.resolvedAddress,this.queryHoldingData.pageLimit,i);this.queryHoldingData.total=m.total,this.queryHoldingData.offset=m.offset,this.queryHoldingData.state=2,this.queryHoldingData.tableData.splice(0,this.queryHoldingData.tableData.length);let e=!1;for(const l of m.results){const r=l.value.repr.substring(1),c=this.queryHoldingData.resultCache[r];c?this.queryHoldingData.tableData.push(c):(e=!0,this.queryHoldingData.tableData.push({id:r,loadingState:0,block:0,dataType:"",dataLength:"",optInfo:{imageUrl:"",imageWidth:"",text:""}}))}(s||e&&this.queryHoldingData.total<=this.queryHoldingData.pageLimit)&&this.loadAllContent()},onClickChangePage(){this.queryHoldingPage(this.queryHoldingData.curPage)},async loadAllContent(){try{await this.realLoadAllContent()}finally{}},async realLoadAllContent(){this.bInRequestEncounterFail=!1,this.queryHoldingData.startLoadAllFlag++,this.queryHoldingData.curInRequestCount=0;let t=0;for(;!this.bInRequestEncounterFail&&t<this.queryHoldingData.tableData.length;)this.queryHoldingData.curInRequestCount<this.queryHoldingData.kMaxInRequestCount?(this.queryHoldingData.curInRequestCount++,this.loadInscription(this.queryHoldingData.startLoadAllFlag,t,this.queryHoldingData.tableData[t].id),++t):await new Promise(s=>setTimeout(s,1e3))},async loadInscription(t,s,i){const m=B(T(i));let e=this.queryHoldingData.tableData[s];try{e.loadingState=1;const r=await fetch(`${R.coreApiUrl}/v2/map_entry/${h.defaultContractAddress}/${h.inscriptionsContract.name}/map_inscriptions`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},proof:0,body:JSON.stringify(m)});if(t!=this.queryHoldingData.startLoadAllFlag)return;if(r.status==200){const c=await r.json(),u=z(c.data).value.data,x=Number(F(u.block)),f=F(u.type),C=u.payload.buffer,A=C.length;let p={imageUrl:null,text:null},H=!1;if(f.startsWith("image/")){p.imageUrl=window.URL.createObjectURL(new Blob([C],{type:f})),H=!0;var l=new Image;l.src=p.imageUrl;let k=this;l.onload=function(){t==k.queryHoldingData.startLoadAllFlag&&(e.loadingState=2,e.optInfo.imageWidth=Math.ceil(l.width*k.kFixImageHeight/l.height))}}else(f=="text"||f=="deploy-stx10")&&(p.text=new TextDecoder().decode(u.payload.buffer));H||(e.loadingState=2),e.id=i,e.block=x,e.dataType=f,e.dataLength=A,e.owner="",e.optInfo.imageUrl=p.imageUrl,e.optInfo.imageWidth=p.imageWidth,e.optInfo.text=p.text,this.queryHoldingData.resultCache[i]=e,this.queryHoldingData.curInRequestCount=Math.max(this.queryHoldingData.curInRequestCount-1,0)}else this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${i}, code=${r.status}, please try again 1 minute later.`)}catch(r){console.err(`loadInscription fail:${t},tableIndex:${s},id:${i},err:${r}`),this.bInRequestEncounterFail=!0,d.alert(`Request server fail, tokenId=${i}, please try again 1 minute later.`)}finally{e.loadingState=2}},async onClickTransferInscription(){const t=E.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{await this.readyTransferInscription()}finally{t.close()}},async readyTransferInscription(){const t=this.tranInsData.tokenId.trim(),s=await V.resolveAddress(this.tranInsData.address.trim());if(s.ret!=0){d.alert(s.errMsg);return}if(!d.parseAddress(s.value)){d.alertInvalidAddress();return}const i=await Y.queryNFTOwner(t);if(!i){d.alert(`Inscription #${t} not exist!`);return}if(i.toLowerCase()!=w().toLowerCase()){d.alert(`No permission! Owner of Inscription #${t} is <a style="color:white" href="https://explorer.hiro.so/address/${i}?chain=${L()}" target="_blank">${i}</a>`);return}if(i.toLowerCase()==s.value.toLowerCase()){d.alert("Receiver cann't be equal with current login address!");return}const m=[T(t),Q(w()),d.parseAddress(s.value)],e="inscription",l=T(t),r=W(h.defaultContractAddress,h.inscriptionsContract.name,e),c=Z(w(),M.Sends,r,l),_={contractAddress:h.defaultContractAddress,contractName:h.inscriptionsContract.name,functionName:"transfer",functionArgs:m,network:R,appDetails:X(),postConditions:[c],onFinish:u=>{d.alert(`Transfer transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${u.txId}?chain=${L()}" target="_blank">Visit transaction.</a>`)}};j(_)}}},ee=t=>(G("data-v-0e5c14ef"),t=t(),K(),t),te={id:"main"},ae=ee(()=>I("div",{id:"title"},"Tools",-1)),ne={id:"tip"},oe={key:0,style:{margin:"50px auto",width:"800px"}},se={class:"queryResultTxt"},le={key:0},ie={key:1},re={key:2},de=["src","width","height"],ue={key:3},ce={class:"queryResultTxt"};function ge(t,s,i,m,e,l){const r=g("el-input"),c=g("el-col"),_=g("el-button"),u=g("el-form-item"),x=g("router-link"),f=g("el-form"),C=g("el-tab-pane"),A=g("el-tabs"),p=g("el-table-column"),H=g("el-table"),k=g("el-pagination");return y(),b("div",te,[ae,n(A,{modelValue:e.activeTabName,"onUpdate:modelValue":s[3]||(s[3]=a=>e.activeTabName=a),size:"large"},{default:o(()=>[n(C,{label:"Query holdings",name:"query-holdings"},{default:o(()=>[n(f,{model:e.queryHoldingData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[n(u,{label:"address"},{default:o(()=>[n(c,{span:14},{default:o(()=>[n(r,{modelValue:e.queryHoldingData.address,"onUpdate:modelValue":s[0]||(s[0]=a=>e.queryHoldingData.address=a),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1}),e.bSignedIn?(y(),v(c,{key:0,span:4},{default:o(()=>[n(_,{style:{"margin-left":"4px"},type:"primary",plain:"",onClick:l.onClickFillAddress},{default:o(()=>[D("Fill current account")]),_:1},8,["onClick"])]),_:1})):q("",!0)]),_:1}),n(u,null,{default:o(()=>[n(_,{type:"primary",onClick:l.onClickQueryHoldings,loading:e.queryHoldingData.state==1,disabled:!l.queryHoldingsBtnValid},{default:o(()=>[D("Query")]),_:1},8,["onClick","loading","disabled"])]),_:1}),e.queryHoldingData.bClickQueryHoldingsFlag?q("",!0):(y(),v(u,{key:0},{default:o(()=>[I("div",ne,[D("Tips: can query stx10 balance in "),n(x,{id:"tipLink",to:{path:"/stx10",query:{tab:"query-balance"}},replace:""},{default:o(()=>[D("stx10")]),_:1}),D(" menu.")])]),_:1}))]),_:1},8,["model"])]),_:1}),n(C,{label:"Transfer inscription",name:"transfer-inscription"},{default:o(()=>[n(f,{model:e.tranInsData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[n(u,{label:"inscription id"},{default:o(()=>[n(c,{span:14},{default:o(()=>[n(r,{modelValue:e.tranInsData.tokenId,"onUpdate:modelValue":s[1]||(s[1]=a=>e.tranInsData.tokenId=a),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(u,{label:"address"},{default:o(()=>[n(c,{span:14},{default:o(()=>[n(r,{modelValue:e.tranInsData.address,"onUpdate:modelValue":s[2]||(s[2]=a=>e.tranInsData.address=a),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1})]),_:1}),n(u,null,{default:o(()=>[n(_,{type:"primary",onClick:l.onClickTransferInscription,disabled:!l.transferInsBtnValid},{default:o(()=>[D(N(e.bSignedIn?"Transfer":"Sign in to transfer"),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),e.activeTabName=="query-holdings"&&e.queryHoldingData.state==2?(y(),b("div",oe,[e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),v(_,{key:0,type:"primary",size:"large",onClick:l.loadAllContent},{default:o(()=>[D("Load content")]),_:1},8,["onClick"])):q("",!0),n(H,{size:"small",data:e.queryHoldingData.tableData,"empty-text":"No inscriptions"},{default:o(()=>[n(p,{label:"Inscription #",width:"110"},{default:o(a=>[I("div",se,N(a.row.id),1)]),_:1}),n(p,{label:"Content"},{default:o(a=>[I("div",null,[a.row.loadingState==1?(y(),b("div",le,"loading..")):q("",!0),a.row.loadingState==2&&(a.row.dataType=="text"||a.row.dataType=="deploy-stx10")?(y(),b("div",ie,[n(r,{modelValue:a.row.optInfo.text,"onUpdate:modelValue":S=>a.row.optInfo.text=S,readonly:"",type:"textarea",autosize:{minRows:1,maxRows:3},resize:"none"},null,8,["modelValue","onUpdate:modelValue"])])):a.row.loadingState==2&&a.row.dataType.startsWith("image/")?(y(),b("div",re,[I("img",{src:a.row.optInfo.imageUrl,width:a.row.optInfo.imageWidth,height:e.kFixImageHeight,alt:""},null,8,de)])):a.row.loadingState==2?(y(),b("div",ue," Not support preview yet. ")):q("",!0)])]),_:1}),n(p,{label:"Content type",width:"150"},{default:o(a=>[I("div",ce,N(a.row.dataType),1)]),_:1})]),_:1},8,["data"]),e.queryHoldingData.state==2&&e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),v(k,{key:1,style:{"margin-top":"16px"},layout:"total, prev, pager, next","default-page-size":e.queryHoldingData.pageLimit,"current-page":e.queryHoldingData.curPage,"onUpdate:currentPage":s[4]||(s[4]=a=>e.queryHoldingData.curPage=a),total:e.queryHoldingData.total,onCurrentChange:l.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):q("",!0)])):q("",!0)])}const me=U($,[["render",ge],["__scopeId","data-v-0e5c14ef"]]);export{me as default};
