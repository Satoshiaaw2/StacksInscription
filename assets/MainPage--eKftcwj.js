import{_ as u,c as p,o as f,a as y,U as c}from"./index-Cc1XKo18.js";/* empty css                  *//* empty css                  *//* empty css                         */import{s as h}from"./supabase-BSODWJIt.js";const g={name:"MainPage",components:{},data(){return{bInitLoadFinish:!1,totalInscriptionCount:0,curPage:1,kMaxImageLen:160,kAudioNameLen:64,kAudioDescLen:64,kPageSize:25,gotoPage:"",tableData:[],asyncInfo:{id:0,kMaxInRequestCount:10,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0},bNonDSMode:!1,switchTip:"Request server error, you can switch to non dedicated server mode."}},async mounted(){this.$router.push({path:"/detail/0"})},methods:{setTableData(o){let n=[];this.tableData.splice(0,this.tableData.length);for(let e=0;e<o.length;e++){const t=o[e];let i={key:t.id,id:t.id,block:t.block,dataType:t.type,owner:"",payload:"",optInfo:{imageUrl:"",imageWidth:"",imageHeight:this.kMaxImageLen,originImageWidth:0,originImageHeight:0,text:"",audioName:"",audioDesc:"",audioUrl:""}};if(i.dataType=="text"||i.dataType=="deploy-stx10")i.payload=t.payload,i.optInfo.text=t.payload;else{const s=t.payload.split("_*|");s.length==3&&s[1].endsWith(`_${i.id}`)?n.push({index:e,inscData:i,syncUrl:s[1]}):console.log("setTableData error",s,i)}this.tableData.push(i)}this.syncTable(n)},async syncTable(o){if(!o||o.length==0)return;let n=this.asyncInfo.id+1;this.asyncInfo.id=n,this.asyncInfo.curInRequestCount=0,this.asyncInfo.retryTimes=0,this.asyncInfo.bFailFlag=!1;let e=0;for(;n==this.asyncInfo.id&&!this.asyncInfo.bFailFlag&&e<o.length;)this.asyncInfo.curInRequestCount<this.asyncInfo.kMaxInRequestCount?(++this.asyncInfo.curInRequestCount,this.syncOne(n,o[e++])):await new Promise(t=>setTimeout(t,1e3))},async syncOne(o,n){const e=n.inscData;let t=null,i=!1;for(;;){const a=localStorage.getItem(n.syncUrl);if(a){t=c.base64ToBlob(a,"text/plain");break}const{data:r,error:l}=await h.storage.from("payload").download(n.syncUrl);if(o!=this.asyncInfo.id)return;if(l){if(++this.asyncInfo.retryTimes>this.asyncInfo.kMaxRetryTimes){this.asyncInfo.bFailFlag=!0;return}await new Promise(d=>setTimeout(d,5e3))}t=r,i=!0;break}if(e.payload=t,e.dataType.startsWith("image/")){e.optInfo.imageUrl=window.URL.createObjectURL(new Blob([t],{type:e.dataType}));var s=new Image;s.src=e.optInfo.imageUrl;let a=this;s.onload=function(){e.optInfo.originImageWidth=s.width,e.optInfo.originImageHeight=s.height,s.width>s.height?(e.optInfo.imageWidth=a.kMaxImageLen,e.optInfo.imageHeight=Math.ceil(s.height*a.kMaxImageLen/s.width)):(e.optInfo.imageHeight=a.kMaxImageLen,e.optInfo.imageWidth=Math.ceil(s.width*a.kMaxImageLen/s.height)),e.key=e.key+1,a.$forceUpdate()}}else if(e.dataType.startsWith("audio/")){const a=new Uint8Array(await t.arrayBuffer()),r=a.slice(a.length-this.kAudioNameLen-this.kAudioDescLen,a.length-this.kAudioDescLen);e.optInfo.audioName=new TextDecoder().decode(r).trim();const l=a.slice(a.length-this.kAudioDescLen);e.optInfo.audioDesc=new TextDecoder().decode(l).trim();const d=a.slice(0,a.length-this.kAudioNameLen-this.kAudioDescLen);e.optInfo.audioUrl=window.URL.createObjectURL(new Blob([d],{type:e.dataType})),e.key=e.key+1,this.$forceUpdate()}i&&c.blobToBase64(t,function(a){try{localStorage.setItem(n.syncUrl,a)}catch(r){r.toString().includes("exceeded the quota")&&(console.log("exceeded the quota, purge"),localStorage.clear())}}),this.asyncInfo.curInRequestCount=Math.max(this.asyncInfo.curInRequestCount-1,0)},onClickChangePage(){this.loadCurrentPage()},async loadCurrentPage(){const o=this.totalInscriptionCount-(this.curPage-1)*this.kPageSize;try{const{data:n,error:e,status:t}=await h.from("inscriptions").select("id, block, type, payload").lte("id",o).order("id",{ascending:!1}).limit(this.kPageSize);t==200&&!e?this.setTableData(n):(console.log(`mounted req fail: status:${t}, error:${JSON.stringify(e)}`),c.alert(this.switchTip))}catch{c.alert(this.switchTip)}},onClickItem(o){const n=this.$router.resolve({path:`/detail/${o}`});window.open(n.href,"_blank")},openLink(o){window.open(o,"_blank")}}},I={class:"main-page cyber-page-base main-page-bg"};function m(o,n,e,t,i,s){return f(),p("div",I,[y("",!0)])}const D=u(g,[["render",m],["__scopeId","data-v-75bb4dcf"]]);export{D as default};
