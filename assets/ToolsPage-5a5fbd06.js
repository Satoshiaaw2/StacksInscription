import{_ as P,U as u,z as W,D as w,j as B,u as T,k as z,E,i as R,N as Q,L as j,O as M,H as O,a as h,o as y,c as b,e as n,w as o,s as v,f as H,v as J,x as K,m as D,b as I,t as x,q as G,p as X,g as Y,I as Z}from"./index-4a8964e0.js";import{c as U,C as $,f as ee}from"./ContractHelper-b7036098.js";import{C as V}from"./ChainHelper-3685232a.js";const F=J(),f=K(),te={name:"ToolsPage",components:{},data(){return{u,bSignedIn:W.isUserSignedIn(),kFixImageHeight:128,kAudioNameLen:64,kAudioDescLen:64,defaultReadonlyAddress:f.defaultContractAddress,activeTabName:"query-holdings",queryHoldingData:{address:"",resolvedAddress:"",nftName:"inscription",state:0,pageLimit:25,total:0,curPage:1,resultCache:{},tableData:[],bInRequestEncounterFail:!1,startLoadAllFlag:0,curInRequestCount:0,kMaxInRequestCount:10,bClickQueryHoldingsFlag:!1},tranInsData:{tokenId:"",address:""}}},computed:{queryHoldingsBtnValid(){return this.queryHoldingData.address.trim().length>0},transferInsBtnValid(){return this.bSignedIn&&/^[0-9]{1,16}$/.test(this.tranInsData.tokenId.trim())&&this.tranInsData.address.trim().length>0}},async mounted(){},methods:{onClickFillAddress(){this.queryHoldingData.address=w()},async onClickQueryHoldings(){this.queryHoldingData.bClickQueryHoldingsFlag=!0,this.queryHoldingData.state=1;const a=await V.resolveAddress(this.queryHoldingData.address.trim());if(a.ret!=0){this.queryHoldingData.state=0,u.alert(a.errMsg);return}if(!u.parseAddress(a.value)){this.queryHoldingData.state=0,u.alertInvalidAddress();return}this.queryHoldingData.resolvedAddress=a.value,this.queryHoldingPage(1,!0)},async queryHoldingPage(a,i){this.queryHoldingData.state=1;const r=(a-1)*this.queryHoldingData.pageLimit,_=await V.getNFTHoldings(f.defaultContractAddress,f.inscriptionsContract.name,this.queryHoldingData.nftName,this.queryHoldingData.resolvedAddress,this.queryHoldingData.pageLimit,r);this.queryHoldingData.total=_.total,this.queryHoldingData.offset=_.offset,this.queryHoldingData.state=2,this.queryHoldingData.tableData.splice(0,this.queryHoldingData.tableData.length);let e=!1;for(const s of _.results){const d=s.value.repr.substring(1),p=this.queryHoldingData.resultCache[d];p?this.queryHoldingData.tableData.push(p):(e=!0,this.queryHoldingData.tableData.push({id:d,loadingState:0,block:0,dataType:"",dataLength:"",optInfo:{imageUrl:"",imageWidth:"",originImageWidth:0,originImageHeight:0,text:"",audioName:"",audioDesc:"",audioUrl:""}}))}(i||e&&this.queryHoldingData.total<=this.queryHoldingData.pageLimit)&&this.loadAllContent()},onClickChangePage(){this.queryHoldingPage(this.queryHoldingData.curPage)},async loadAllContent(){try{await this.realLoadAllContent()}finally{}},async realLoadAllContent(){this.bInRequestEncounterFail=!1,this.queryHoldingData.startLoadAllFlag++,this.queryHoldingData.curInRequestCount=0;let a=0;for(;!this.bInRequestEncounterFail&&a<this.queryHoldingData.tableData.length;)this.queryHoldingData.curInRequestCount<this.queryHoldingData.kMaxInRequestCount?(this.queryHoldingData.curInRequestCount++,this.loadInscription(this.queryHoldingData.startLoadAllFlag,a,this.queryHoldingData.tableData[a].id),++a):await new Promise(i=>setTimeout(i,1e3))},async loadInscription(a,i,r){const _=B(T(r));let e=this.queryHoldingData.tableData[i];try{e.loadingState=1;const d=await fetch(`${F.coreApiUrl}/v2/map_entry/${f.defaultContractAddress}/${f.inscriptionsContract.name}/map_inscriptions`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},proof:0,body:JSON.stringify(_)});if(a!=this.queryHoldingData.startLoadAllFlag)return;if(d.status==200){const p=await d.json(),c=z(p.data).value.data,A=Number(U(c.block)),m=U(c.type),g=c.payload.buffer,N=g.length;let l={imageUrl:null,text:null},k=!1;if(m.startsWith("image/")){l.imageUrl=window.URL.createObjectURL(new Blob([g],{type:m})),k=!0;var s=new Image;s.src=l.imageUrl;let C=this;s.onload=function(){a==C.queryHoldingData.startLoadAllFlag&&(e.loadingState=2,e.optInfo.originImageWidth=s.width,e.optInfo.originImageHeight=s.height,e.optInfo.imageWidth=Math.ceil(s.width*C.kFixImageHeight/s.height))}}else if(m.startsWith("audio/")){const C=g.slice(g.length-this.kAudioNameLen-this.kAudioDescLen,g.length-this.kAudioDescLen);l.audioName=new TextDecoder().decode(C).trim();const t=g.slice(g.length-this.kAudioDescLen);l.audioDesc=new TextDecoder().decode(t).trim();const L=g.slice(0,g.length-this.kAudioNameLen-this.kAudioDescLen);l.audioUrl=window.URL.createObjectURL(new Blob([L],{type:m}))}else(m=="text"||m=="deploy-stx10")&&(l.text=new TextDecoder().decode(c.payload.buffer));k||(e.loadingState=2),e.id=r,e.block=A,e.dataType=m,e.dataLength=N,e.owner="",e.optInfo.imageUrl=l.imageUrl,e.optInfo.imageWidth=l.imageWidth,e.optInfo.originImageWidth=l.originImageWidth,e.optInfo.originImageHeight=l.originImageHeight,e.optInfo.text=l.text,e.optInfo.audioName=l.audioName,e.optInfo.audioDesc=l.audioDesc,e.optInfo.audioUrl=l.audioUrl,this.queryHoldingData.resultCache[r]=e,this.queryHoldingData.curInRequestCount=Math.max(this.queryHoldingData.curInRequestCount-1,0)}else this.bInRequestEncounterFail=!0,u.alert(`Request server fail, tokenId=${r}, code=${d.status}, please try again 1 minute later.`)}catch(d){console.err(`loadInscription fail:${a},tableIndex:${i},id:${r},err:${d}`),this.bInRequestEncounterFail=!0,u.alert(`Request server fail, tokenId=${r}, please try again 1 minute later.`)}finally{e.loadingState=2}},async onClickTransferInscription(){const a=E.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{await this.readyTransferInscription()}finally{a.close()}},async readyTransferInscription(){const a=this.tranInsData.tokenId.trim(),i=await V.resolveAddress(this.tranInsData.address.trim());if(i.ret!=0){u.alert(i.errMsg);return}if(!u.parseAddress(i.value)){u.alertInvalidAddress();return}const r=await $.queryNFTOwner(a);if(!r){u.alert(`Inscription #${a} not exist!`);return}if(r.toLowerCase()!=w().toLowerCase()){u.alert(`No permission! Owner of Inscription #${a} is <a style="color:white" href="https://explorer.hiro.so/address/${r}?chain=${R()}" target="_blank">${r}</a>`);return}if(r.toLowerCase()==i.value.toLowerCase()){u.alert("Receiver cann't be equal with current login address!");return}const _=[T(a),Q(w()),u.parseAddress(i.value)],e="inscription",s=T(a),d=j(f.defaultContractAddress,f.inscriptionsContract.name,e),p=ee(w(),M.Sends,d,s),q={contractAddress:f.defaultContractAddress,contractName:f.inscriptionsContract.name,functionName:"transfer",functionArgs:_,network:F,appDetails:Z(),postConditions:[p],onFinish:c=>{u.alert(`Transfer transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${c.txId}?chain=${R()}" target="_blank">Visit transaction.</a>`)}};O(q)}}},S=a=>(X("data-v-6f174d56"),a=a(),Y(),a),ae={id:"main"},ne=S(()=>I("div",{id:"title"},"Tools",-1)),oe={id:"tip"},ie={key:0,style:{margin:"50px auto",width:"800px"}},se={class:"queryResultTxt"},le={key:0},re={key:1},de={key:2},ue=["src","width","height"],ce={key:3},ge=["src"],pe=S(()=>I("span",{class:"audioKey"},"Name: ",-1)),he={key:4},ye={class:"queryResultTxt"};function me(a,i,r,_,e,s){const d=h("el-input"),p=h("el-col"),q=h("el-button"),c=h("el-form-item"),A=h("router-link"),m=h("el-form"),g=h("el-tab-pane"),N=h("el-tabs"),l=h("el-table-column"),k=h("el-table"),C=h("el-pagination");return y(),b("div",ae,[ne,n(N,{modelValue:e.activeTabName,"onUpdate:modelValue":i[3]||(i[3]=t=>e.activeTabName=t),size:"large"},{default:o(()=>[n(g,{label:"Query holdings",name:"query-holdings"},{default:o(()=>[n(m,{model:e.queryHoldingData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[n(c,{label:"address"},{default:o(()=>[n(p,{span:14},{default:o(()=>[n(d,{modelValue:e.queryHoldingData.address,"onUpdate:modelValue":i[0]||(i[0]=t=>e.queryHoldingData.address=t),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1}),e.bSignedIn?(y(),v(p,{key:0,span:4},{default:o(()=>[n(q,{style:{"margin-left":"4px"},type:"primary",plain:"",onClick:s.onClickFillAddress},{default:o(()=>[D("Fill current account")]),_:1},8,["onClick"])]),_:1})):H("",!0)]),_:1}),n(c,null,{default:o(()=>[n(q,{type:"primary",onClick:s.onClickQueryHoldings,loading:e.queryHoldingData.state==1,disabled:!s.queryHoldingsBtnValid},{default:o(()=>[D("Query")]),_:1},8,["onClick","loading","disabled"])]),_:1}),e.queryHoldingData.bClickQueryHoldingsFlag?H("",!0):(y(),v(c,{key:0},{default:o(()=>[I("div",oe,[D("Tips: can query stx10 balance in "),n(A,{id:"tipLink",to:{path:"/stx10",query:{tab:"query-balance"}},replace:""},{default:o(()=>[D("stx10")]),_:1}),D(" menu.")])]),_:1}))]),_:1},8,["model"])]),_:1}),n(g,{label:"Transfer inscription",name:"transfer-inscription"},{default:o(()=>[n(m,{model:e.tranInsData,"label-width":"100px",class:"tabInner",size:"large"},{default:o(()=>[n(c,{label:"inscription id"},{default:o(()=>[n(p,{span:14},{default:o(()=>[n(d,{modelValue:e.tranInsData.tokenId,"onUpdate:modelValue":i[1]||(i[1]=t=>e.tranInsData.tokenId=t),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(c,{label:"address"},{default:o(()=>[n(p,{span:14},{default:o(()=>[n(d,{modelValue:e.tranInsData.address,"onUpdate:modelValue":i[2]||(i[2]=t=>e.tranInsData.address=t),placeholder:"Address or BNS name"},null,8,["modelValue"])]),_:1})]),_:1}),n(c,null,{default:o(()=>[n(q,{type:"primary",onClick:s.onClickTransferInscription,disabled:!s.transferInsBtnValid},{default:o(()=>[D(x(e.bSignedIn?"Transfer":"Sign in to transfer"),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),e.activeTabName=="query-holdings"&&e.queryHoldingData.state==2?(y(),b("div",ie,[e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),v(q,{key:0,type:"primary",size:"large",onClick:s.loadAllContent},{default:o(()=>[D("Load content")]),_:1},8,["onClick"])):H("",!0),n(k,{size:"small",data:e.queryHoldingData.tableData,"empty-text":"No inscriptions"},{default:o(()=>[n(l,{label:"Inscription #",width:"110"},{default:o(t=>[I("div",se,x(t.row.id),1)]),_:1}),n(l,{label:"Content"},{default:o(t=>[I("div",null,[t.row.loadingState==1?(y(),b("div",le,"loading..")):H("",!0),t.row.loadingState==2&&(t.row.dataType=="text"||t.row.dataType=="deploy-stx10")?(y(),b("div",re,[n(d,{modelValue:t.row.optInfo.text,"onUpdate:modelValue":L=>t.row.optInfo.text=L,readonly:"",type:"textarea",autosize:{minRows:1,maxRows:3},resize:"none"},null,8,["modelValue","onUpdate:modelValue"])])):t.row.loadingState==2&&t.row.dataType.startsWith("image/")?(y(),b("div",de,[I("img",{src:t.row.optInfo.imageUrl,width:t.row.optInfo.imageWidth,height:e.kFixImageHeight,class:G({nn:t.row.optInfo.originImageWidth<=64&&t.row.optInfo.originImageHeight<=64&&t.row.optInfo.originImageWidth>0&&t.row.optInfo.originImageHeight>0}),alt:""},null,10,ue)])):t.row.loadingState==2&&t.row.dataType.startsWith("audio/")?(y(),b("div",ce,[I("audio",{controls:"",src:t.row.optInfo.audioUrl},null,8,ge),I("div",null,[pe,D(" "+x(t.row.optInfo.audioName),1)])])):t.row.loadingState==2?(y(),b("div",he," Not support preview yet. ")):H("",!0)])]),_:1}),n(l,{label:"Content type",width:"150"},{default:o(t=>[I("div",ye,x(t.row.dataType),1)]),_:1})]),_:1},8,["data"]),e.queryHoldingData.state==2&&e.queryHoldingData.total>e.queryHoldingData.pageLimit?(y(),v(C,{key:1,style:{"margin-top":"16px"},layout:"total, prev, pager, next","default-page-size":e.queryHoldingData.pageLimit,"current-page":e.queryHoldingData.curPage,"onUpdate:currentPage":i[4]||(i[4]=t=>e.queryHoldingData.curPage=t),total:e.queryHoldingData.total,onCurrentChange:s.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):H("",!0)])):H("",!0)])}const De=P(te,[["render",me],["__scopeId","data-v-6f174d56"]]);export{De as default};
