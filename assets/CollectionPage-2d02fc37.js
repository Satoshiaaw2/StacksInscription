import{_ as I,a as y,o as n,c as r,e as p,w,b as u,t as m,q as k,U as f,m as D,f as c,F as b,d as C,s as M}from"./index-b9d4469b.js";import"./ContractHelper-5627ab15.js";import{s as g}from"./supabase-dc56852f.js";import"./browser-ponyfill-71ec9403.js";const x={name:"CollectionInscriptionItem",props:["inscData"],async mounted(){}},v={class:"textArea"},T={key:0},P=["src","width","height"],L={key:2},U={class:"inscNo"};function S(s,o,e,i,t,a){const l=y("el-card");return n(),r("div",null,[p(l,{"body-style":{padding:"0px"},id:"insc",shadow:"hover"},{default:w(()=>[u("div",v,[e.inscData.dataType=="text"||e.inscData.dataType=="deploy-stx10"?(n(),r("div",T,m(e.inscData.optInfo.text),1)):e.inscData.dataType.startsWith("image/")?(n(),r("img",{key:1,src:e.inscData.optInfo.imageUrl,width:e.inscData.optInfo.imageWidth,height:e.inscData.optInfo.imageHeight,class:k({nn:e.inscData.optInfo.originImageWidth<=64&&e.inscData.optInfo.originImageHeight<=64&&e.inscData.optInfo.originImageWidth>0&&e.inscData.optInfo.originImageHeight>0}),alt:""},null,10,P)):(n(),r("span",L,"Parse error"))]),u("div",U," #"+m(e.inscData.id),1)]),_:1})])}const F=I(x,[["render",S],["__scopeId","data-v-55c89441"]]);const R={name:"CollectionDetailPage",components:{CollectionInscriptionItem:F},data(){return{kFixImageHeight:400,collectionId:"",collectionName:"",loading:null,summary:{id:"",name:"",iconUrl:"",rangeStart:0,rangeEnd:0,detail:"",shortDetail:"",showMoreMode:0,website:"",twitter:"",discord:"",telegram:"",priority:0,idList:[]},totalInscriptionCount:0,curPage:1,kMaxImageLen:236,kPageSize:50,asyncInfo:{id:0,kMaxInRequestCount:15,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0},tableData:[],asyncInfo:{id:0,kMaxInRequestCount:8,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0}}},async mounted(){if(!this.$route.params.hasOwnProperty("id"))return;const s=this.$route.params.id;!s||s.length==0||(this.collectionId=s,this.loadCollectionDB(s),this.loadCollectionStorage(s))},methods:{async loadCollectionDB(s){const{data:o,error:e,status:i}=await g.from("collection").select("*").eq("id",s).limit(1);if(i==200&&!e&&o.length==1){const t=o[0];let a=this.summary;a.id=t.id,a.name=t.name,a.iconUrl=t.iconurl,a.rangeStart=t.startno,a.rangeEnd=t.endno,a.detail=t.detail,a.website=t.website,a.twitter=t.twitter,a.discord=t.discord,a.telegram=t.telegram,a.priority=t.priority,console.log("loadCollectionDB",a),this.updateToggleFoldData()}else console.log("Load collection fail, status:",i,"error: ",e),f.alert("Load collection fail, please try later")},async loadCollectionStorage(s){const{data:o,error:e}=await g.storage.from("collection").download(s);if(e){f.alert("Load storage fail, please try later");return}const i=await o.text(),a=JSON.parse(i).split(",");this.summary.idList=[];for(const l of a)this.summary.idList.push(parseInt(l));this.totalInscriptionCount=this.summary.idList.length,this.showPage(1)},async showPage(s){this.curPage=s;let o=[];const e=(s-1)*this.kPageSize,i=Math.min(e+this.kPageSize,this.summary.idList.length);for(let d=e;d<i;d++){const _=this.summary.idList[d];o.push(_)}const{data:t,error:a,status:l}=await g.from("inscriptions").select("id, type, payload").order("id",{ascending:!0}).in("id",o).limit(this.kPageSize);l==200&&!a?this.setTableData(t):(console.log("showPage error:",s,a),f.alert("Load error, please try again later"))},setTableData(s){let o=[];this.tableData.splice(0,this.tableData.length);for(let e=0;e<s.length;e++){const i=s[e];let t={key:i.id,id:i.id,block:i.block,dataType:i.type,owner:"",payload:"",optInfo:{imageUrl:"",imageWidth:"",imageHeight:this.kMaxImageLen,originImageWidth:0,originImageHeight:0,text:""}};if(t.dataType=="text"||t.dataType=="deploy-stx10")t.payload=i.payload,t.optInfo.text=i.payload;else{const a=i.payload.split("_*|");a.length==3&&a[1].endsWith(`_${t.id}`)?o.push({index:e,inscData:t,syncUrl:a[1]}):console.log("setTableData error",a,t)}this.tableData.push(t)}this.syncTable(o)},async syncTable(s){if(!s||s.length==0)return;let o=this.asyncInfo.id+1;this.asyncInfo.id=o,this.asyncInfo.curInRequestCount=0,this.asyncInfo.retryTimes=0,this.asyncInfo.bFailFlag=!1;let e=0;for(;o==this.asyncInfo.id&&!this.asyncInfo.bFailFlag&&e<s.length;)this.asyncInfo.curInRequestCount<this.asyncInfo.kMaxInRequestCount?(++this.asyncInfo.curInRequestCount,this.syncOne(o,s[e++])):await new Promise(i=>setTimeout(i,1e3))},async syncOne(s,o){const e=o.inscData;let i=null;for(;;){const{data:a,error:l}=await g.storage.from("payload").download(o.syncUrl);if(s!=this.asyncInfo.id)return;if(l){if(++this.asyncInfo.retryTimes>this.asyncInfo.kMaxRetryTimes){this.asyncInfo.bFailFlag=!0;return}await new Promise(d=>setTimeout(d,5e3))}i=a;break}if(e.payload=i,e.dataType.startsWith("image/")){e.optInfo.imageUrl=window.URL.createObjectURL(new Blob([i],{type:e.dataType}));var t=new Image;t.src=e.optInfo.imageUrl;let a=this;t.onload=function(){e.optInfo.originImageWidth=t.width,e.optInfo.originImageHeight=t.height,t.width>t.height?(e.optInfo.imageWidth=a.kMaxImageLen,e.optInfo.imageHeight=Math.ceil(t.height*a.kMaxImageLen/t.width)):(e.optInfo.imageHeight=a.kMaxImageLen,e.optInfo.imageWidth=Math.ceil(t.width*a.kMaxImageLen/t.height)),e.key*=-1,a.$forceUpdate()}}this.asyncInfo.curInRequestCount=Math.max(this.asyncInfo.curInRequestCount-1,0)},async onClickChangePage(){this.showPage(this.curPage)},onClickItem(s){const o=this.tableData[s],e=this.$router.resolve({path:`/inscription/${o.id}`});window.open(e.href,"_blank")},updateToggleFoldData(){this.summary.shortDetail="",this.summary.showMoreMode=0;const s=250;if(this.summary.detail.length>s){let o=s;for(let e=s;e<s+20;e++)if(this.summary.detail.substr(e,1)==" "){o=e;break}this.summary.shortDetail=this.summary.detail.substr(0,o)+"...",this.summary.showMoreMode=1}},toggleShowMore(){this.summary.showMoreMode=this.summary.showMoreMode==1?2:1,console.log("___showMoreMode: ",this.summary.showMoreMode)}}},q={id:"main"},W={key:0,id:"summaryArea"},z={id:"title"},B={id:"rangeArea"},H={id:"desc"},N={id:"linkUrls"},V=["href"],A=["href"],E=["href"],O=["href"],j={key:1,id:"memberArea"},J=["onClick"];function G(s,o,e,i,t,a){const l=y("el-avatar"),d=y("CollectionInscriptionItem"),_=y("el-pagination");return n(),r("div",q,[t.summary.name.length>0?(n(),r("div",W,[p(l,{shape:"circle",size:100,src:t.summary.iconUrl},null,8,["src"]),u("div",z,m(t.summary.name),1),u("div",B,"#"+m(t.summary.rangeStart)+" - #"+m(t.summary.rangeEnd),1),u("div",H,[D(m(t.summary.showMoreMode==1?t.summary.shortDetail:t.summary.detail)+" ",1),t.summary.showMoreMode!=0?(n(),r("button",{key:0,onClick:o[0]||(o[0]=(...h)=>a.toggleShowMore&&a.toggleShowMore(...h)),id:"showMoreBtn"},m(t.summary.showMoreMode==1?"Show more":"Show less"),1)):c("",!0)]),u("div",N,[t.summary.website.length>0?(n(),r("a",{key:0,href:t.summary.website,target:"_blank",class:"linkUrl"},"Website",8,V)):c("",!0),t.summary.twitter.length>0?(n(),r("a",{key:1,href:t.summary.twitter,target:"_blank",class:"linkUrl"},"Twitter",8,A)):c("",!0),t.summary.discord.length>0?(n(),r("a",{key:2,href:t.summary.discord,target:"_blank",class:"linkUrl"},"Discord",8,E)):c("",!0),t.summary.telegram.length>0?(n(),r("a",{key:3,href:t.summary.telegram,target:"_blank",class:"linkUrl"},"Telegram",8,O)):c("",!0)])])):c("",!0),t.tableData.length>0?(n(),r("div",j,[(n(!0),r(b,null,C(t.tableData.length,h=>(n(),r("button",{key:t.tableData[h-1].key,class:"member",onClick:K=>a.onClickItem(h-1)},[p(d,{inscData:t.tableData[h-1]},null,8,["inscData"])],8,J))),128))])):c("",!0),t.tableData.length>0?(n(),M(_,{key:2,style:{margin:"32px auto"},layout:"total, prev, pager, next, jumper","default-page-size":t.kPageSize,"current-page":t.curPage,"onUpdate:currentPage":o[1]||(o[1]=h=>t.curPage=h),total:t.totalInscriptionCount,onCurrentChange:a.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):c("",!0)])}const $=I(R,[["render",G],["__scopeId","data-v-0e77ce5d"]]);export{$ as default};
