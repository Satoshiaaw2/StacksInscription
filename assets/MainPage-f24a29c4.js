import{_ as I,U as l,r as b,a as p,o as d,c as h,b as m,F as w,d as k,e as g,f,p as _,g as v,h as x}from"./index-a98134a3.js";import{s as y}from"./supabase-0db6c682.js";const C={name:"MainPage",components:{},data(){return{bInitLoadFinish:!1,totalInscriptionCount:0,curPage:1,kMaxImageLen:180,kAudioNameLen:64,kAudioDescLen:64,kPageSize:50,tableData:[],asyncInfo:{id:0,kMaxInRequestCount:10,kMaxRetryTimes:10,retryTimes:0,bFailFlag:!1,curInRequestCount:0},bNonDSMode:!1,switchTip:"Request server error, you can switch to non dedicated server mode."}},async mounted(){try{this.bInitLoadFinish=!1;const{data:i,error:a,status:e}=await y.from("inscriptions").select("id, block, type, payload").order("id",{ascending:!1}).limit(this.kPageSize);e==200&&!a?(this.setTableData(i),this.tableData.length>0&&(this.totalInscriptionCount=this.tableData[0].id)):(console.log(`mounted req fail: status:${e}, error:${JSON.stringify(a)}`),l.alert(this.switchTip))}catch{l.alert(this.switchTip)}finally{this.bInitLoadFinish=!0}},methods:{async loadPage(i){},setTableData(i){let a=[];this.tableData.splice(0,this.tableData.length);for(let e=0;e<i.length;e++){const s=i[e];let t={key:s.id,id:s.id,block:s.block,dataType:s.type,owner:"",payload:"",optInfo:{imageUrl:"",imageWidth:"",imageHeight:this.kMaxImageLen,originImageWidth:0,originImageHeight:0,text:"",audioName:"",audioDesc:"",audioUrl:""}};if(t.dataType=="text"||t.dataType=="deploy-stx10")t.payload=s.payload,t.optInfo.text=s.payload;else{const o=s.payload.split("_*|");o.length==3&&o[1].endsWith(`_${t.id}`)?a.push({index:e,inscData:t,syncUrl:o[1]}):console.log("setTableData error",o,t)}this.tableData.push(t)}this.syncTable(a)},async syncTable(i){if(!i||i.length==0)return;let a=this.asyncInfo.id+1;this.asyncInfo.id=a,this.asyncInfo.curInRequestCount=0,this.asyncInfo.retryTimes=0,this.asyncInfo.bFailFlag=!1;let e=0;for(;a==this.asyncInfo.id&&!this.asyncInfo.bFailFlag&&e<i.length;)this.asyncInfo.curInRequestCount<this.asyncInfo.kMaxInRequestCount?(++this.asyncInfo.curInRequestCount,this.syncOne(a,i[e++])):await new Promise(s=>setTimeout(s,1e3))},async syncOne(i,a){const e=a.inscData;let s=null,t=!1;for(;;){const n=localStorage.getItem(a.syncUrl);if(n){s=l.base64ToBlob(n,"text/plain");break}const{data:c,error:u}=await y.storage.from("payload").download(a.syncUrl);if(i!=this.asyncInfo.id)return;if(u){if(++this.asyncInfo.retryTimes>this.asyncInfo.kMaxRetryTimes){this.asyncInfo.bFailFlag=!0;return}await new Promise(r=>setTimeout(r,5e3))}s=c,t=!0;break}if(e.payload=s,e.dataType.startsWith("image/")){e.optInfo.imageUrl=window.URL.createObjectURL(new Blob([s],{type:e.dataType}));var o=new Image;o.src=e.optInfo.imageUrl;let n=this;o.onload=function(){e.optInfo.originImageWidth=o.width,e.optInfo.originImageHeight=o.height,o.width>o.height?(e.optInfo.imageWidth=n.kMaxImageLen,e.optInfo.imageHeight=Math.ceil(o.height*n.kMaxImageLen/o.width)):(e.optInfo.imageHeight=n.kMaxImageLen,e.optInfo.imageWidth=Math.ceil(o.width*n.kMaxImageLen/o.height)),e.key*=-1,n.$forceUpdate()}}else if(e.dataType.startsWith("audio/")){const n=new Uint8Array(await s.arrayBuffer()),c=n.slice(n.length-this.kAudioNameLen-this.kAudioDescLen,n.length-this.kAudioDescLen);e.optInfo.audioName=new TextDecoder().decode(c).trim();const u=n.slice(n.length-this.kAudioDescLen);e.optInfo.audioDesc=new TextDecoder().decode(u).trim();const r=n.slice(0,n.length-this.kAudioNameLen-this.kAudioDescLen);e.optInfo.audioUrl=window.URL.createObjectURL(new Blob([r],{type:e.dataType})),e.key*=-1,this.$forceUpdate()}t&&l.blobToBase64(s,function(n){try{localStorage.setItem(a.syncUrl,n)}catch(c){c.toString().includes("exceeded the quota")&&(console.log("exceeded the quota, purge"),localStorage.clear())}}),this.asyncInfo.curInRequestCount=Math.max(this.asyncInfo.curInRequestCount-1,0)},async onClickChangePage(){const i=this.totalInscriptionCount-(this.curPage-1)*this.kPageSize;try{const{data:a,error:e,status:s}=await y.from("inscriptions").select("id, block, type, payload").lte("id",i).order("id",{ascending:!1}).limit(this.kPageSize);s==200&&!e?this.setTableData(a):(console.log(`mounted req fail: status:${s}, error:${JSON.stringify(e)}`),l.alert(this.switchTip))}catch{l.alert(this.switchTip)}},onClickItem(i){const a=this.tableData[i],e=this.$router.resolve({path:`/inscription/${a.id}`});window.open(e.href,"_blank")},onChangeDSMode(){setTimeout(()=>{b.push({path:"/direct",replace:!0})},100)}}},D=i=>(_("data-v-b67aa4a1"),i=i(),v(),i),T={id:"main"},L=D(()=>m("div",{id:"title"},"Latest inscriptions",-1)),M={id:"memberArea"},P=["onClick"],q={key:0,id:"pagiArea"},U={key:1,id:"dsArea"},A={key:2,id:"outerLinks"},S=x('<a href="https://x.com/stxinscriptions" target="_blank" class="outerLink" data-v-b67aa4a1><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16" data-v-b67aa4a1><path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334q.002-.211-.006-.422A6.7 6.7 0 0 0 16 3.542a6.7 6.7 0 0 1-1.889.518 3.3 3.3 0 0 0 1.447-1.817 6.5 6.5 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.32 9.32 0 0 1-6.767-3.429 3.29 3.29 0 0 0 1.018 4.382A3.3 3.3 0 0 1 .64 6.575v.045a3.29 3.29 0 0 0 2.632 3.218 3.2 3.2 0 0 1-.865.115 3 3 0 0 1-.614-.057 3.28 3.28 0 0 0 3.067 2.277A6.6 6.6 0 0 1 .78 13.58a6 6 0 0 1-.78-.045A9.34 9.34 0 0 0 5.026 15" data-v-b67aa4a1></path></svg></a><a href="https://discord.gg/e6zdwqrvw6" target="_blank" class="outerLink" data-v-b67aa4a1><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-discord" viewBox="0 0 16 16" data-v-b67aa4a1><path d="M13.545 2.907a13.2 13.2 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.2 12.2 0 0 0-3.658 0 8 8 0 0 0-.412-.833.05.05 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.04.04 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032q.003.022.021.037a13.3 13.3 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019q.463-.63.818-1.329a.05.05 0 0 0-.01-.059l-.018-.011a9 9 0 0 1-1.248-.595.05.05 0 0 1-.02-.066l.015-.019q.127-.095.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.05.05 0 0 1 .053.007q.121.1.248.195a.05.05 0 0 1-.004.085 8 8 0 0 1-1.249.594.05.05 0 0 0-.03.03.05.05 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.2 13.2 0 0 0 4.001-2.02.05.05 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.03.03 0 0 0-.02-.019m-8.198 7.307c-.789 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612m5.316 0c-.788 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612" data-v-b67aa4a1></path></svg></a><a href="https://t.me/stacksinscription" target="_blank" class="outerLink" data-v-b67aa4a1><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16" data-v-b67aa4a1><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.287 5.906q-1.168.486-4.666 2.01-.567.225-.595.442c-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294q.39.01.868-.32 3.269-2.206 3.374-2.23c.05-.012.12-.026.166.016s.042.12.037.141c-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8 8 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629q.14.092.27.187c.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.4 1.4 0 0 0-.013-.315.34.34 0 0 0-.114-.217.53.53 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09" data-v-b67aa4a1></path></svg></a>',3),F=[S];function N(i,a,e,s,t,o){const n=p("InscriptionItem"),c=p("el-pagination"),u=p("el-switch");return d(),h("div",T,[L,m("div",M,[(d(!0),h(w,null,k(t.tableData.length,r=>(d(),h("button",{key:t.tableData[r-1].key,class:"member",onClick:R=>o.onClickItem(r-1)},[g(n,{inscData:t.tableData[r-1]},null,8,["inscData"])],8,P))),128))]),t.bInitLoadFinish&&t.totalInscriptionCount>t.kPageSize?(d(),h("div",q,[g(c,{layout:"total, prev, pager, next, jumper","default-page-size":t.kPageSize,"current-page":t.curPage,"onUpdate:currentPage":a[0]||(a[0]=r=>t.curPage=r),total:t.totalInscriptionCount,onCurrentChange:o.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])])):f("",!0),t.bInitLoadFinish?(d(),h("div",U,[g(u,{modelValue:t.bNonDSMode,"onUpdate:modelValue":a[1]||(a[1]=r=>t.bNonDSMode=r),"active-text":"Non dedicated server","inactive-text":"Dedicated server",onChange:o.onChangeDSMode},null,8,["modelValue","onChange"])])):f("",!0),t.bInitLoadFinish?(d(),h("div",A,F)):f("",!0)])}const W=I(C,[["render",N],["__scopeId","data-v-b67aa4a1"]]);export{W as default};
