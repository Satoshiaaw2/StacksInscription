import{_ as D,z as B,U as h,E as x,i as C,D as _,C as w,B as T,G as A,H as v,A as F,a as k,o as l,c,e as N,w as p,f as d,s as b,F as P,d as z,b as g,m as f,t as m,q as U,p as H,g as M,I as q,v as L,x as E}from"./index-98f36be6.js";import{b as V,F as W,m as X}from"./ContractHelper-05d93702.js";import{C as y}from"./ChainHelper-a242cf75.js";window.Buffer=window.Buffer||V.Buffer;const R=L(),I=E(),j={name:"BulkInscribeImagePage",components:{},data(){return{bSignedIn:B.isUserSignedIn(),kMaxBuffLen:1022976,pendingCount:0,loadPendingDataState:0,kFixHeight:100,kBurnUnit:5e4,tableData:[],loadAllImagesState:0,bInInscribingAllImages:!1}},computed:{needBurnStx(){let e=0;for(const a of this.tableData)a.pendingTx.length==0&&(e+=this.kBurnUnit);return e}},async mounted(){if(!this.bSignedIn)return;this.loadPendingDataState=1,this.pendingCount=await this.queryPendingTxCount(),this.loadPendingDataState=2;let e=this;setInterval(async()=>{e.pendingCount=await e.queryPendingTxCount()},1e4)},methods:{readImageFiles(){const e=this.$refs.images.files.length;if(e<=0)return;let a=this;a.loadAllImagesState=1;let n=0,r={};for(let t=0;t<e;t++){let i=t;this.loadFile(i,this.$refs.images.files[i],function(o,u,s){if(!o){h.alert(s.errMsg),a.loadAllImagesState=0;return}r[i]=s,++n==e&&a.loadAllImagesFinish(n,r)})}},loadFile(e,a,n){W.fromBlob(a).then(r=>{if(!r||!r.mime||!r.mime.startsWith("image/")){const u=`Error: the ${e+1}th file(${a.name}) is not image.`;n(!1,e,{errMsg:u});return}let t={fileType:r.mime,fileName:a.name,fileSize:a.size,imageUrl:window.URL.createObjectURL(a),pendingTx:""};var i=new Image;i.src=t.imageUrl;let o=this;i.onload=function(){t.originWidth=i.width,t.originHeight=i.height,t.width=Math.ceil(i.width*o.kFixHeight/i.height),t.height=o.kFixHeight,n(!0,e,t)}},r=>{const t=`Error: deal ${e+1}th file error(fromBlob)`;n(!1,e,{errMsg:t})})},loadAllImagesFinish(e,a){this.loadAllImagesState=2,this.needBurnStx=e*5e4,this.tableData.splice(0,this.tableData.length);for(let n=0;n<e;n++)this.tableData.push(a[n])},async onClickBulkInscribe(){const e=x.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{if(e.setText("Check pending transactions.."),this.pendingCount=await this.queryPendingTxCount(),this.tableData.length+this.pendingCount>25){let n="";this.pendingCount>0&&(n=`Has ${this.pendingCount} pending transactions. `),n+=`At most select ${25-this.pendingCount} files.`,h.alert(n);return}do if(e.setText("Check balance.."),C()=="devnet",await y.getAccountBalance(_())<this.needBurnStx+5e3*this.tableData.length){h.alert(`Need burn ${this.needBurnStx/1e6} STX, balance unenough!`);return}while(!1);{e.setText("Check file size..");for(let n=0;n<this.tableData.length;n++)if(this.tableData[n].fileSize>1022976){h.alert(`Max 1022976 bytes(999k), ${this.tableData[n].fileName} size is ${this.tableData[n].fileSize} bytes(${Math.floor(this.tableData[n].fileSize/1024)}k).`);return}}e.close();let a=this;this.$confirm(`Probably need adjust fee manully each times wallet popups!
If wallet shows error, close it and click "Continue inscribe".`,"Attention",{confirmButtonText:"Got it",type:"warning"}).then(()=>{a.bInInscribingAllImages=!0,a.startCalls(0)})}finally{e.close()}},onClickContinueBulkInscribe(){for(let e=0;e<this.tableData.length;e++)if(this.tableData[e].pendingTx.length==0){this.startCalls(e);break}},async startCalls(e){if(e>=this.tableData.length){this.bInInscribingAllImages=!1,this.pendingCount=await this.queryPendingTxCount(),h.alert("Finish");return}const a=new FileReader;let n=this;a.onload=async function(){var r=new Uint8Array(a.result);if(r.length>1022976)return;const t=[w(n.tableData[e].fileType),T(r)];let i=[];i.push(X(_(),A.LessEqual,5e4));const o={contractAddress:I.defaultContractAddress,contractName:I.inscriptionsContract.name,functionName:"inscribe_misc",functionArgs:t,network:R,appDetails:q(),postConditions:i,onFinish:u=>{n.tableData[e].pendingTx=u.txId,n.startCalls(++e)}};v(o)},a.readAsArrayBuffer(this.$refs.images.files[e])},async queryPendingTxCount(){const e=await y.queryAddressNonceInfo(_());return e.last_mempool_tx_nonce?e.last_mempool_tx_nonce-e.last_executed_tx_nonce:0},onClickSignIn(){F()},_getNetType(){return C()},onClickTest(){}}},S=e=>(H("data-v-d54e3698"),e=e(),M(),e),G={id:"main"},O=S(()=>g("div",{id:"title"},"Bulk inscribe images",-1)),J={key:0},K={key:1},Q={key:0},Y=S(()=>g("span",null,"File size limit is 999k, but wallet may not respond if exceeds 600k currently.",-1)),Z={style:{"margin-top":"8px"}},$=["disabled"],ee={key:3,style:{"margin-top":"32px"}},te={key:4,style:{"margin-top":"16px"}},ne=["src","width","height"],ie=["href"],ae={style:{"margin-top":"16px"}},se={key:0},le={key:2,id:"burnTip"};function re(e,a,n,r,t,i){const o=k("el-button"),u=k("el-space");return l(),c("div",G,[O,t.bSignedIn?d("",!0):(l(),c("div",J,[N(o,{type:"primary",size:"large",onClick:i.onClickSignIn},{default:p(()=>[f("Sign in to inscribe")]),_:1},8,["onClick"])])),t.bSignedIn&&t.loadPendingDataState==1?(l(),c("div",K," Loading.. ")):d("",!0),t.bSignedIn&&t.loadPendingDataState==2?(l(),b(u,{key:2,id:"tipArea",direction:"vertical",alignment:"start"},{default:p(()=>[g("div",null,[f("Each address can have up to 25 pending transactions"),t.pendingCount>0?(l(),c("span",Q,"("+m(t.pendingCount)+" txs is pending now)",1)):d("",!0),f(".")]),Y,g("div",Z,[g("span",null,"Select up to "+m(25-t.pendingCount)+" files: ",1),g("input",{type:"file",ref:"images",multiple:"",onChange:a[0]||(a[0]=s=>i.readImageFiles()),disabled:t.bInInscribingAllImages||t.pendingCount>=25},null,40,$)])]),_:1})):d("",!0),t.loadAllImagesState==1?(l(),c("div",ee,"Loading..")):d("",!0),t.loadAllImagesState==2?(l(),c("div",te,[(l(!0),c(P,null,z(t.tableData.length,s=>(l(),b(u,{direction:"vertical",key:s,class:"imageItem"},{default:p(()=>[g("img",{src:t.tableData[s-1].imageUrl,width:t.tableData[s-1].width,height:t.tableData[s-1].height,class:U({nn:t.tableData[s-1].originWidth<=64&&t.tableData[s-1].originHeight<=64&&t.tableData[s-1].originWidth>0&&t.tableData[s-1].originHeight>0}),alt:""},null,10,ne),g("span",null,m(t.tableData[s-1].fileName),1),t.tableData[s-1].pendingTx.length>0?(l(),c("a",{key:0,style:{color:"white"},href:"https://explorer.hiro.so/txid/"+t.tableData[s-1].pendingTx+"?chain="+i._getNetType(),target:"_blank"},"Transaction",8,ie)):d("",!0)]),_:2},1024))),128)),g("div",ae,[t.tableData.length>0&&t.tableData[0].pendingTx.length>0&&i.needBurnStx>0?(l(),b(o,{key:0,type:"primary",size:"large",onClick:i.onClickContinueBulkInscribe},{default:p(()=>[f(" Continue inscribe "),g("span",null,"("+m(i.needBurnStx/1e6)+" STX)",1)]),_:1},8,["onClick"])):(l(),b(o,{key:1,type:"primary",size:"large",onClick:i.onClickBulkInscribe,disabled:i.needBurnStx==0},{default:p(()=>[f(" Bulk inscribe "),i.needBurnStx>0?(l(),c("span",se,"("+m(i.needBurnStx/1e6)+" STX)",1)):d("",!0)]),_:1},8,["onClick","disabled"])),i.needBurnStx>0?(l(),c("div",le,"(Inscribe fee is burned)")):d("",!0)])])):d("",!0)])}const de=D(j,[["render",re],["__scopeId","data-v-d54e3698"]]);export{de as default};
