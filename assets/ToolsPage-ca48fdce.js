import{_ as U,u as P,y as w,E as V,c as B,a as v,h as E,g as N,D as L,G as z,N as W,z as j,r as c,o as g,d as I,j as n,w as s,l as T,i as b,m as M,n as O,f as x,t as A,e as q,p as Q,q as G,A as J}from"./index-d391c2de.js";import{c as S,C as K,a as X}from"./ContractHelper-526dc384.js";import{C as Y}from"./ChainHelper-f4db8498.js";import{U as p}from"./utils-b205d640.js";const F=M(),y=O(),Z={name:"ToolsPage",components:{},data(){return{u:p,bSignedIn:P.isUserSignedIn(),kFixImageHeight:128,defaultReadonlyAddress:y.defaultContractAddress,activeTabName:"query-holdings",queryHoldingData:{address:"",nftName:"StacksInscription",state:0,pageLimit:25,total:0,curPage:1,resultCache:{},tableData:[],bInRequestEncounterFail:!1,startLoadAllFlag:0,curInRequestCount:0,kMaxInRequestCount:10},tranInsData:{tokenId:"",address:""}}},computed:{queryHoldingsBtnValid(){return p.parseAddress(this.queryHoldingData.address)!=null},transferInsBtnValid(){return this.bSignedIn&&/^[0-9]{1,16}$/.test(this.tranInsData.tokenId.trim())&&p.parseAddress(this.tranInsData.address)!=null}},async mounted(){},methods:{onClickFillAddress(){this.queryHoldingData.address=w()},async onClickQueryHoldings(){this.queryHoldingPage(1,!0)},async queryHoldingPage(a,o){const r=(a-1)*this.queryHoldingData.pageLimit,h=await Y.getNFTHoldings(y.defaultContractAddress,y.inscriptionsContract.name,this.queryHoldingData.nftName,this.queryHoldingData.address,this.queryHoldingData.pageLimit,r);this.queryHoldingData.total=h.total,this.queryHoldingData.offset=h.offset,this.queryHoldingData.state=2,this.queryHoldingData.tableData.splice(0,this.queryHoldingData.tableData.length);let t=!1;for(const l of h.results){const i=l.value.repr.substring(1),d=this.queryHoldingData.resultCache[i];d?this.queryHoldingData.tableData.push(d):(t=!0,this.queryHoldingData.tableData.push({id:i,loadingState:0,block:0,dataType:"",dataLength:"",optInfo:{imageUrl:"",imageWidth:"",text:""}}))}(o||t&&this.queryHoldingData.total<=this.queryHoldingData.pageLimit)&&this.loadAllContent()},onClickChangePage(){this.queryHoldingPage(this.queryHoldingData.curPage)},loadAllContent(){const a=V.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{this.realLoadAllContent()}finally{a.close()}},async realLoadAllContent(){this.bInRequestEncounterFail=!1,this.queryHoldingData.startLoadAllFlag++,this.queryHoldingData.curInRequestCount=0;let a=0;for(;!this.bInRequestEncounterFail&&a<this.queryHoldingData.tableData.length;)++this.queryHoldingData.curInRequestCount<=this.queryHoldingData.kMaxInRequestCount?(this.loadInscription(this.queryHoldingData.startLoadAllFlag,a,this.queryHoldingData.tableData[a].id),++a):await new Promise(o=>setTimeout(o,1e3))},async loadInscription(a,o,r){const h=B(v(r));let t=this.queryHoldingData.tableData[o];try{t.loadingState=1;const i=await fetch(`${F.coreApiUrl}/v2/map_entry/${y.defaultContractAddress}/${y.inscriptionsContract.name}/map_inscriptions`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},proof:0,body:JSON.stringify(h)});if(a!=this.queryHoldingData.startLoadAllFlag)return;if(i.status==200){const d=await i.json(),u=E(d.data).value.data,C=Number(S(u.block)),m=S(u.type),H=u.payload.buffer,D=H.length;let f={imageUrl:null,text:null},k=!1;if(m.startsWith("image/")){f.imageUrl=window.URL.createObjectURL(new Blob([H],{type:m})),k=!0;var l=new Image;l.src=f.imageUrl;let e=this;l.onload=function(){a==e.queryHoldingData.startLoadAllFlag&&(t.loadingState=2,t.optInfo.imageWidth=Math.ceil(l.width*e.kFixImageHeight/l.height))}}else(m=="text"||m=="deploy-stx10")&&(f.text=new TextDecoder().decode(u.payload.buffer));k||(t.loadingState=2),t.id=r,t.block=C,t.dataType=m,t.dataLength=D,t.owner="",t.optInfo.imageUrl=f.imageUrl,t.optInfo.imageWidth=f.imageWidth,t.optInfo.text=f.text,this.queryHoldingData.resultCache[r]=t,this.queryHoldingData.curInRequestCount=Math.max(this.queryHoldingData.curInRequestCount-1,0)}else this.bInRequestEncounterFail=!0,p.alert(`Request server fail, tokenId=${r}, code=${i.status}, please try again 1 minute later.`)}catch(i){console.err(`loadInscription fail:${a},tableIndex:${o},id:${r},err:${i}`),this.bInRequestEncounterFail=!0,p.alert(`Request server fail, tokenId=${r}, please try again 1 minute later.`)}finally{t.loadingState=2}},async onClickTransferInscription(){const a=V.service({lock:!0,background:"rgba(0, 0, 0, 0.6)"});try{this.readyTransferInscription()}finally{a.close()}},async readyTransferInscription(){const a=this.tranInsData.tokenId.trim();this.tranInsData.address=this.tranInsData.address.trim();const o=await K.queryNFTOwner(a);if(!o){p.alert(`Inscription #${a} not exist!`);return}if(o.toLowerCase()!=w().toLowerCase()){p.alert(`No permission! Owner of Inscription #${a} is <a style="color:white" href="https://explorer.hiro.so/address/${o}?chain=${N()}" target="_blank">${o}</a>`);return}if(o.toLowerCase()==this.tranInsData.address.toLowerCase()){p.alert("Receiver cann't be equal with current login address!");return}const r=[v(a),L(w()),L(this.tranInsData.address)],h="StacksInscription",t=v(a),l=z(y.defaultContractAddress,y.inscriptionsContract.name,h),i=X(w(),W.Sends,l,t),d={contractAddress:y.defaultContractAddress,contractName:y.inscriptionsContract.name,functionName:"transfer",functionArgs:r,network:F,appDetails:J(),postConditions:[i],onFinish:_=>{p.alert(`Transfer transaction has been sent. <a style="color:white" href="https://explorer.hiro.so/txid/${_.txId}?chain=${N()}" target="_blank">Visit transaction.</a>`)}};j(d)}}},$=a=>(Q("data-v-3906b12e"),a=a(),G(),a),tt={id:"main"},et=$(()=>q("div",{id:"title"},"Tools",-1)),at={key:0,style:{margin:"50px auto",width:"800px"}},nt={class:"queryResultTxt"},ot={key:0},st={key:1},lt={key:2},it=["src","width","height"],rt={key:3},dt={class:"queryResultTxt"};function ut(a,o,r,h,t,l){const i=c("el-input"),d=c("el-col"),_=c("el-button"),u=c("el-form-item"),C=c("el-form"),m=c("el-tab-pane"),H=c("el-tabs"),D=c("el-table-column"),f=c("el-table"),k=c("el-pagination");return g(),I("div",tt,[et,n(H,{modelValue:t.activeTabName,"onUpdate:modelValue":o[3]||(o[3]=e=>t.activeTabName=e),size:"large"},{default:s(()=>[n(m,{label:"Query holdings",name:"query-holdings"},{default:s(()=>[n(C,{model:t.queryHoldingData,"label-width":"100px",class:"tabInner",size:"large"},{default:s(()=>[n(u,{label:"address"},{default:s(()=>[n(d,{span:14},{default:s(()=>[n(i,{modelValue:t.queryHoldingData.address,"onUpdate:modelValue":o[0]||(o[0]=e=>t.queryHoldingData.address=e),placeholder:""},null,8,["modelValue"])]),_:1}),t.bSignedIn?(g(),T(d,{key:0,span:4},{default:s(()=>[n(_,{style:{"margin-left":"4px"},type:"primary",plain:"",onClick:l.onClickFillAddress},{default:s(()=>[x("Fill current account")]),_:1},8,["onClick"])]),_:1})):b("",!0)]),_:1}),n(u,null,{default:s(()=>[n(_,{type:"primary",onClick:l.onClickQueryHoldings,disabled:!l.queryHoldingsBtnValid},{default:s(()=>[x("Query")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),n(m,{label:"Transfer inscription",name:"transfer-inscription"},{default:s(()=>[n(C,{model:t.tranInsData,"label-width":"100px",class:"tabInner",size:"large"},{default:s(()=>[n(u,{label:"inscription id"},{default:s(()=>[n(d,{span:14},{default:s(()=>[n(i,{modelValue:t.tranInsData.tokenId,"onUpdate:modelValue":o[1]||(o[1]=e=>t.tranInsData.tokenId=e),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(u,{label:"address"},{default:s(()=>[n(d,{span:14},{default:s(()=>[n(i,{modelValue:t.tranInsData.address,"onUpdate:modelValue":o[2]||(o[2]=e=>t.tranInsData.address=e),placeholder:""},null,8,["modelValue"])]),_:1})]),_:1}),n(u,null,{default:s(()=>[n(_,{type:"primary",onClick:l.onClickTransferInscription,disabled:!l.transferInsBtnValid},{default:s(()=>[x(A(t.bSignedIn?"Transfer":"Sign in to transfer"),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),t.activeTabName=="query-holdings"&&t.queryHoldingData.state==2?(g(),I("div",at,[t.queryHoldingData.total>t.queryHoldingData.pageLimit?(g(),T(_,{key:0,type:"primary",plain:"",onClick:l.loadAllContent},{default:s(()=>[x("Load content")]),_:1},8,["onClick"])):b("",!0),n(f,{size:"small",data:t.queryHoldingData.tableData,"empty-text":"No inscriptions"},{default:s(()=>[n(D,{label:"Inscription #",width:"110"},{default:s(e=>[q("div",nt,A(e.row.id),1)]),_:1}),n(D,{label:"Content"},{default:s(e=>[q("div",null,[e.row.loadingState==1?(g(),I("div",ot,"loading..")):b("",!0),e.row.loadingState==2&&(e.row.dataType=="text"||e.row.dataType=="deploy-stx10")?(g(),I("div",st,[n(i,{modelValue:e.row.optInfo.text,"onUpdate:modelValue":R=>e.row.optInfo.text=R,readonly:"",type:"textarea",autosize:{minRows:1,maxRows:3}},null,8,["modelValue","onUpdate:modelValue"])])):e.row.loadingState==2&&e.row.dataType.startsWith("image/")?(g(),I("div",lt,[q("img",{src:e.row.optInfo.imageUrl,width:e.row.optInfo.imageWidth,height:t.kFixImageHeight,alt:""},null,8,it)])):e.row.loadingState==2?(g(),I("div",rt," Not support preview yet. ")):b("",!0)])]),_:1}),n(D,{label:"Content type",width:"150"},{default:s(e=>[q("div",dt,A(e.row.dataType),1)]),_:1})]),_:1},8,["data"]),t.queryHoldingData.state==2&&t.queryHoldingData.total>t.queryHoldingData.pageLimit?(g(),T(k,{key:1,style:{"margin-top":"16px"},background:"",layout:"total, prev, pager, next","default-page-size":t.queryHoldingData.pageLimit,"current-page":t.queryHoldingData.curPage,"onUpdate:currentPage":o[4]||(o[4]=e=>t.queryHoldingData.curPage=e),total:t.queryHoldingData.total,onCurrentChange:l.onClickChangePage},null,8,["default-page-size","current-page","total","onCurrentChange"])):b("",!0)])):b("",!0)])}const ht=U(Z,[["render",ut],["__scopeId","data-v-3906b12e"]]);export{ht as default};
